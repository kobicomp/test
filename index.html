<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניתוח נתוני רישום - יום סבבא אגף בנות</title>
    
    <!-- ספריות חיצוניות -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4a2c82;
            --primary-light: #f8f6ff;
            --secondary-color: #6a41b4;
            --success-color: #28a745;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --gray-color: #e9ecef;
            --border-radius: 12px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f6fb;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .logo-container {
            margin-bottom: 20px;
        }
        
        .logo {
            max-width: 200px;
            display: none; /* יוצג רק אם יש תמונה */
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 25px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
            min-height: 300px;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            text-align: center;
            color: var(--danger-color);
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .card-body {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="logo.png" alt="לוגו" class="logo" onload="this.style.display='block'">
        </div>
        <h1>ניתוח נתוני רישום - יום סבבא אגף בנות</h1>
    </header>
    
    <div id="loading" class="loading-container">
        <div class="loader"></div>
        <h2>טוען נתוני רישום...</h2>
    </div>
    
    <div id="error" class="error-message">
        <p>אירעה שגיאה בטעינת הנתונים. אנא נסה שוב מאוחר יותר.</p>
        <p id="errorDetails"></p>
    </div>
    
    <div id="dashboard" class="dashboard" style="display: none;">
        <!-- כרטיס התפלגות לפי כיתות -->
        <div class="card">
            <div class="card-header">
                התפלגות רישום לפי כיתה
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="classDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script>
// ===== הגדרות =====
const CONFIG = {
    // קישור לגליון הנתונים
    SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-tw481NC9DzPt3RBOEoiGdeGv6FNRjC28NbKUuvY2bNWIdSqR4BmQTe8-n6RndK4NDOgVFtUirqU4/pub?output=csv',
    // מידע מעודכן על גודלי כיתות עם השמות המלאים
    CLASS_SIZES: {
        'א\' עדי רחמני': 24,
        'א\' רעות שיף': 23,
        'ב\' הדר כהן': 30,
        'ג\' שירה חדאד': 21,
        'ד\' הדר כחלון': 30,
        'ו\' ספיר צדוק': 25
    }
};

// משתנים גלובליים
let rawData = [];
let processedData = {
    totalStudents: 0,
    totalFamilies: 0,
    classCounts: {},
    classesWithNoShow: {},
    classesTotalStudents: {}
};

// טעינת נתונים
async function loadData() {
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('error').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    
    try {
        const response = await fetch(CONFIG.SHEET_URL);
        if (!response.ok) throw new Error(`שגיאת שרת: ${response.status}`);
        const csvText = await response.text();
        parseCSV(csvText);
    } catch (error) {
        console.error('שגיאה בטעינת הנתונים:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorDetails').textContent = error.message;
    }
}

// ניתוח קובץ CSV
function parseCSV(csvText) {
    Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            if (results.errors.length > 0) {
                showError("שגיאה בניתוח הקובץ");
                return;
            }
            
            rawData = results.data;
            analyzeData(rawData);
            renderDashboard();
        },
        error: function(error) {
            showError("שגיאה בניתוח הקובץ: " + error.message);
        }
    });
}

// ניתוח הנתונים
function analyzeData(data) {
    processedData = {
        totalStudents: 0,
        totalFamilies: data.length,
        classCounts: {},
        classesWithNoShow: {},
        classesTotalStudents: { ...CONFIG.CLASS_SIZES }
    };
    
    data.forEach(row => {
        const notAttending = row["לא מגיעים"] ? true : false;
        
        // חיפוש תלמידות ברשומה
        for (let i = 1; i <= 4; i++) {
            const nameKey = `שם התלמיד ${i}`;
            const classKey = `כיתה ${i}`;
            
            if (row[nameKey] && row[classKey]) {
                const studentClass = row[classKey];
                
                // ספירת תלמידות שענו לפי כיתה
                if (!processedData.classCounts[studentClass]) {
                    processedData.classCounts[studentClass] = 0;
                }
                processedData.classCounts[studentClass]++;
                
                // ספירת לא מגיעים לפי כיתה
                if (notAttending) {
                    if (!processedData.classesWithNoShow[studentClass]) {
                        processedData.classesWithNoShow[studentClass] = 0;
                    }
                    processedData.classesWithNoShow[studentClass]++;
                }
                
                processedData.totalStudents++;
            }
        }
    });
}

// הצגת הדשבורד
function renderDashboard() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dashboard').style.display = 'grid';
    
    renderClassDistributionChart();
}

// יצירת תרשים התפלגות כיתות
function renderClassDistributionChart() {
    const ctx = document.getElementById('classDistributionChart').getContext('2d');
    
    const labels = Object.keys(processedData.classCounts).sort();
    const datasets = [];
    
    // הכנת הנתונים
    const totalStudentsData = [];
    const respondedData = [];
    const notAttendingData = [];
    
    labels.forEach(className => {
        // מצא את הכיתה המתאימה ב-CLASS_SIZES
        const classKey = Object.keys(CONFIG.CLASS_SIZES).find(key => 
            key.includes(className) || className.includes(key)
        );
        const totalInClass = classKey ? CONFIG.CLASS_SIZES[classKey] : 0;
        const responded = processedData.classCounts[className] || 0;
        const notAttending = processedData.classesWithNoShow[className] || 0;
        
        totalStudentsData.push(totalInClass);
        respondedData.push(responded);
        notAttendingData.push(notAttending);
    });
    
    // מחיקת תרשים קיים אם יש
    const existingChart = Chart.getChart(ctx);
    if (existingChart) {
        existingChart.destroy();
    }
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'סך תלמידות בכיתה',
                    data: totalStudentsData,
                    backgroundColor: 'rgba(200, 200, 200, 0.2)',
                    borderColor: 'rgba(200, 200, 200, 1)',
                    borderWidth: 1,
                    stack: 'stack0'
                },
                {
                    label: 'ענו לרישום',
                    data: respondedData,
                    backgroundColor: 'rgba(74, 44, 130, 0.8)',
                    borderColor: 'rgba(74, 44, 130, 1)',
                    borderWidth: 1,
                    stack: 'stack1'
                },
                {
                    label: 'מתוכן לא מגיעות',
                    data: notAttendingData,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1,
                    stack: 'stack1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'top',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label;
                            const value = context.parsed.y;
                            const total = totalStudentsData[context.dataIndex];
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${datasetLabel}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// הצגת שגיאה
function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorDetails').textContent = message;
}

// טעינת הנתונים בטעינת הדף
window.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
</body>
</html>
