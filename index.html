<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>מערכת הזמנת חדר דינאמיקלאס</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --empty-cell: #e8f5e9;
            --booked-cell: #ffebee;
            --pending-cell: #fff3e0;
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .room-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .room-info h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .cell-empty {
            background-color: var(--empty-cell);
            cursor: pointer;
        }

        .cell-empty:hover {
            background-color: #d0e8d1;
        }

        .cell-booked {
            background-color: var(--booked-cell);
        }

        .cell-pending {
            background-color: var(--pending-cell);
        }

        .booking-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="room-info">
            <h2 id="room-name">חדר דינאמיקלאס</h2>
            <p id="room-description">חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית</p>
            <p id="room-details">מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים</p>
        </div>

        <div class="controls">
            <button onclick="scheduler.changeWeek(-1)">◀ שבוע קודם</button>
            <span id="current-week"></span>
            <button onclick="scheduler.changeWeek(1)">שבוע הבא ▶</button>
        </div>

        <table id="schedule">
            <thead>
                <tr>
                    <th>שעה</th>
                    <th>ראשון</th>
                    <th>שני</th>
                    <th>שלישי</th>
                    <th>רביעי</th>
                    <th>חמישי</th>
                    <th>שישי</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="booking-form" id="booking-form">
        <h3>הזמנת חדר</h3>
        <form id="reservation-form">
            <div class="form-group">
                <label for="teacher">שם המורה:</label>
                <select id="teacher" required></select>
            </div>
            <div class="form-group">
                <label for="class">כיתה:</label>
                <select id="class" required></select>
            </div>
            <div class="form-group">
                <label for="subject">מקצוע:</label>
                <input type="text" id="subject" required>
            </div>
            <input type="hidden" id="selected-date">
            <input type="hidden" id="selected-hour">
            <button type="submit">שמור</button>
            <button type="button" onclick="scheduler.closeForm()">ביטול</button>
        </form>
    </div>

    <script>
        // שם החדר - משתנה גלובלי
        const ROOM_NAME = "חדר דינאמיקלאס";

        // קונפיגורציה כללית
        const CONFIG = {
            systemName: ROOM_NAME,
            systemDescription: "חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית",
            systemDetails: "מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים",

            daysSchedule: {
                0: { name: 'ראשון', lessons: 7 },
                1: { name: 'שני', lessons: 7 },
                2: { name: 'שלישי', lessons: 5 },
                3: { name: 'רביעי', lessons: 7 },
                4: { name: 'חמישי', lessons: 7 },
                5: { name: 'שישי', lessons: 4 }
            },

            urls: {
                schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR5uPK7t_NLTPGlZR4sU0owKAwoygzxa_924tiZH3dHDEEl-f72zjw1ra1AxObkbpMpLURv61Rv4a8M/pub?output=csv',
                teachers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvRHe90lOs14oPNfL3uRqN73uEgmg7L_ON2gXnCD-CuZ_FmTZDRb-rxmmZmeq4frFxh-IMcGLEfy-/pub?output=csv',
                classes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1t6xbHD1i8uWUFQb5MmaHbjjyOLhcCdxs26f0nIABkNoGULEia-mfdsS78KlLNeZdtJ31X/pub?gid=0&single=true&output=csv',
                form: 'https://docs.google.com/forms/d/e/1FAIpQLSeOFAZPcacD0pPV6ffQW4Eg5FpMvLqyTHjz3RZ1i5KMJeGrkQ/formResponse'
            },

            formFields: {
                teacher: "entry.1323321977",
                class: "entry.1450687623",
                date: "entry.1431651377",
                hour: "entry.1887686014",
                subject: "entry.1869424962",
                roomName: "entry.2087001113"
            },

            maxWeeklyBookings: 4,
            maxWeeksAhead: 4
        };

        // אובייקט ניהול מערכת השעות
        const scheduler = {
            currentWeek: moment(),
            scheduleData: [],
            teachersList: [],
            classesList: [],

            // טעינת נתונים
            async loadData() {
                try {
                    // טעינת רשימת מורים
                    const teachersResponse = await fetch(CONFIG.urls.teachers);
                    const teachersText = await teachersResponse.text();
                    this.teachersList = this.parseList(teachersText);
                    this.populateSelect('teacher', this.teachersList);

                    // טעינת רשימת כיתות
                    const classesResponse = await fetch(CONFIG.urls.classes);
                    const classesText = await classesResponse.text();
                    this.classesList = this.parseList(classesText);
                    this.populateSelect('class', this.classesList);

                    // טעינת לוח זמנים
                    const scheduleResponse = await fetch(CONFIG.urls.schedule);
                    const scheduleText = await scheduleResponse.text();
                    this.scheduleData = this.parseSchedule(scheduleText);

                    // עדכון תצוגה
                    this.renderSchedule();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            },

            // פירוק רשימה מקובץ CSV
            parseList(csv) {
                return csv.split('\n')
                    .map(line => line.split(',')[0].trim())
                    .filter(item => item && item !== 'null');
            },

            // פירוק לוח זמנים מקובץ CSV
            parseSchedule(csv) {
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                return lines.slice(1)
                    .map(line => {
                        const values = line.split(',').map(v => v.trim());
                        const entry = {};
                        headers.forEach((header, i) => {
                            entry[header] = values[i];
                        });
                        return entry;
                    })
                    .filter(entry => 
                        entry['שם החדר'] === ROOM_NAME
                    );
            },

            // אכלוס רשימת בחירה
            populateSelect(id, items) {
                const select = document.getElementById(id);
                select.innerHTML = `<option value="">בחר/י ${id === 'teacher' ? 'מורה' : 'כיתה'}</option>`;
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });
            },

            // עדכון תצוגת לוח זמנים
            renderSchedule() {
                // עדכון פרטי החדר
                document.getElementById('room-name').textContent = ROOM_NAME;

                // הגדרת תאריך שבועי
                const startOfWeek = this.currentWeek.clone().startOf('week');
                document.getElementById('current-week').textContent = 
                    `${startOfWeek.format('DD/MM/YYYY')} - ${startOfWeek.clone().endOf('week').format('DD/MM/YYYY')}`;

                // יצירת לוח זמנים
                const tbody = document.querySelector('#schedule tbody');
                tbody.innerHTML = '';

                // לולאה על שעות הלימוד
                for (let hour = 1; hour <= 7; hour++) {
                    const row = document.createElement('tr');
                    
                    // תא שעה
                    const hourCell = document.createElement('td');
                    hourCell.textContent = `שעה ${hour}`;
                    row.appendChild(hourCell);

                    // תאים לכל יום
                    for (let day = 0; day < 6; day++) {
                        const cell = document.createElement('td');
                        const date = startOfWeek.clone().add(day, 'days').format('YYYY-MM-DD');
                        
                        // בדיקת הזמנה קיימת
                        const booking = this.getBookingForSlot(date, hour);
                        
                        if (booking) {
                            cell.classList.add('cell-booked');
                            cell.innerHTML = `
                                <div>
                                    <strong>${booking['שם המורה']}</strong><br>
                                    כיתה: ${booking['כיתה']}<br>
                                    ${booking['מקצוע']}
                                </div>
                            `;
                        } else {
                            cell.classList.add('cell-empty');
                            cell.textContent = 'פנוי';
                            cell.onclick = () => this.openBookingForm(date, hour);
                        }

                        row.appendChild(cell);
                    }

                    tbody.appendChild(row);
                }
            },

            // בדיקת הזמנה לתא ספציפי
            getBookingForSlot(date, hour) {
                return this.scheduleData.find(booking => 
                    booking.תאריך === date && 
                    parseInt(booking['שעה במערכת']) === hour
                );
            },

            // פתיחת טופס הזמנה
            openBookingForm(date, hour) {
                document.getElementById('selected-date').value = date;
                document.getElementById('selected-hour').value = hour;
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('booking-form').style.display = 'block';
            },

            // סג// סגירת טופס הזמנה
            closeForm() {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('booking-form').style.display = 'none';
            },

            // שינוי שבוע
            changeWeek(delta) {
                this.currentWeek.add(delta, 'weeks');
                this.renderSchedule();
            },

            // טיפול בהגשת הזמנה
            async handleSubmit(event) {
                event.preventDefault();
                
                const formData = {
                    'שם המורה': document.getElementById('teacher').value,
                    'כיתה': document.getElementById('class').value,
                    'תאריך': document.getElementById('selected-date').value,
                    'שעה במערכת': document.getElementById('selected-hour').value,
                    'מקצוע': document.getElementById('subject').value,
                    'שם החדר': ROOM_NAME
                };

                try {
                    // הכנת הנתונים לטופס Google
                    const googleFormData = new FormData();
                    googleFormData.append(CONFIG.formFields.teacher, formData['שם המורה']);
                    googleFormData.append(CONFIG.formFields.class, formData['כיתה']);
                    googleFormData.append(CONFIG.formFields.date, formData['תאריך']);
                    googleFormData.append(CONFIG.formFields.hour, formData['שעה במערכת']);
                    googleFormData.append(CONFIG.formFields.subject, formData['מקצוע']);
                    googleFormData.append(CONFIG.formFields.roomName, formData['שם החדר']);

                    // שליחה לטופס Google
                    await fetch(CONFIG.urls.form, {
                        method: 'POST',
                        body: googleFormData,
                        mode: 'no-cors'
                    });

                    alert('ההזמנה נשלחה בהצלחה');
                    this.closeForm();
                    
                    // רענון נתונים לאחר השליחה
                    await this.loadData();
                } catch (error) {
                    console.error('Error:', error);
                    alert('אירעה שגיאה. נסה שוב מאוחר יותר.');
                }
            }
        };

        // אתחול המערכת
        document.addEventListener('DOMContentLoaded', () => {
            scheduler.loadData();
            document.getElementById('reservation-form').addEventListener('submit', (e) => {
                e.preventDefault();
                scheduler.handleSubmit(e);
            });
        });
    </script>
</body>
</html>
