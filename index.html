<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>מערכת ניהול פרויקטים</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #0bb5a0;
      --warning: #ff9e00;
      --danger: #e63946;
      --info: #4cc9f0;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #adb5bd;
      --white: #ffffff;
      --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      color: var(--dark);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.2);
    }

    .hidden {
      display: none !important;
    }

    h1, h2, h3, h4, h5, h6 {
      color: var(--dark);
      margin-top: 0;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .btn {
      display: inline-block;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      text-align: center;
      font-size: 14px;
    }

    .btn:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
    }

    .btn-lg {
      padding: 12px 20px;
      font-size: 16px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-success {
      background-color: var(--success);
    }

    .btn-success:hover {
      background-color: #099a88;
    }

    .btn-danger {
      background-color: var(--danger);
    }

    .btn-danger:hover {
      background-color: #d32f3d;
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }

    .btn-warning:hover {
      background-color: #e68a00;
    }

    .btn-info {
      background-color: var(--info);
    }

    .btn-info:hover {
      background-color: #3ab7de;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background-color: var(--primary);
      color: var(--white);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      margin: -10px;
    }

    .col {
      flex: 1;
      padding: 10px;
    }

    .project-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .project-card {
      position: relative;
      cursor: pointer;
      overflow: hidden;
      border-right: 5px solid var(--primary);
      height: 100%;
    }

    .project-card-content {
      padding: 15px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .project-card-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: var(--dark);
    }

    .project-card-description {
      color: #6c757d;
      margin-bottom: 10px;
      flex-grow: 1;
    }

    .project-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .project-type-indicator {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .personal-project {
      background-color: #d5f5e3;
      color: #27ae60;
    }

    .team-project {
      background-color: #d4e6f1;
      color: #2980b9;
    }

    .member-list {
      margin-top: 20px;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
      margin-bottom: 8px;
      transition: all 0.3s;
    }

    .member-item:hover {
      background-color: #e9ecef;
    }

    .task-list {
      margin-top: 20px;
    }

    .task-item {
      display: flex;
      padding: 12px;
      background-color: var(--light);
      border-radius: var(--radius);
      margin-bottom: 10px;
      align-items: center;
      transition: all 0.3s;
    }

    .task-item:hover {
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    }

    .task-item.completed {
      background-color: #e8f5e9;
      border-right: 3px solid var(--success);
    }

    .task-content {
      flex-grow: 1;
      margin: 0 15px;
    }

    .task-title {
      margin: 0 0 5px 0;
      font-weight: 500;
      color: var(--dark);
    }

    .task-description {
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
      font-size: 12px;
    }

    .task-due-date {
      color: var(--dark);
    }

    .task-due-date.overdue {
      color: var(--danger);
      font-weight: 500;
    }

    .task-actions {
      display: flex;
      gap: 5px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background-color: var(--white);
      margin: 10% auto;
      padding: 30px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: var(--shadow);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      color: var(--gray);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
      overflow-x: auto;
      white-space: nowrap;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
      color: var(--gray);
      transition: all 0.3s;
    }

    .tab:hover {
      color: var(--primary);
    }

    .tab.active {
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
    }

    .auth-card {
      width: 100%;
      max-width: 400px;
      padding: 30px;
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .badge-owner {
      background-color: #fff3e6;
      color: #ff8c00;
    }

    .badge-member {
      background-color: #e6f3ff;
      color: #0070f3;
    }

    .tag {
      display: inline-block;
      background-color: #e9ecef;
      color: #495057;
      padding: 3px 10px;
      border-radius: 16px;
      font-size: 12px;
      margin: 0 5px 5px 0;
    }

    .tag.high {
      background-color: #f8d7da;
      color: #dc3545;
    }

    .tag.medium {
      background-color: #fff3cd;
      color: #ffc107;
    }

    .tag.low {
      background-color: #d1e7dd;
      color: #198754;
    }

    .tag-blue {
      background-color: #cfe2ff;
      color: #0d6efd;
    }

    .tag-green {
      background-color: #d1e7dd;
      color: #198754;
    }

    .tag-red {
      background-color: #f8d7da;
      color: #dc3545;
    }

    .tag-yellow {
      background-color: #fff3cd;
      color: #ffc107;
    }

    .tag-purple {
      background-color: #e2d9f3;
      color: #6f42c1;
    }

    .tag-cyan {
      background-color: #d7f5fc;
      color: #17a2b8;
    }

    .help-request {
      background-color: #ffedd1;
      border-right: 3px solid var(--warning);
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      margin-bottom: 15px;
    }

    .tag-item {
      display: flex;
      align-items: center;
      background-color: #e9ecef;
      padding: 3px 8px;
      border-radius: 16px;
      font-size: 12px;
    }

    .tag-close {
      margin-right: 5px;
      cursor: pointer;
    }

    .tag-input {
      flex-grow: 1;
      border: none;
      outline: none;
      padding: 5px;
      margin-bottom: 0;
    }

    /* Loader */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(67, 97, 238, 0.2);
      border-radius: 50%;
      border-top: 5px solid var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Dashboard styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dashboard-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dashboard-filter select, .dashboard-filter input {
      margin-bottom: 0;
    }

    .dashboard-section {
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }

    .help-tasks-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff8e1;
      border-radius: var(--radius);
      border-right: 4px solid var(--warning);
    }

    .navbar {
      background-color: var(--white);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .navbar-brand {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
    }

    .nav-item {
      margin-right: 20px;
    }

    .nav-link {
      color: var(--dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    .nav-link:hover {
      color: var(--primary);
    }

    .nav-link.active {
      color: var(--primary);
    }

    .user-menu {
      position: relative;
      cursor: pointer;
    }

    .user-menu-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background-color: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      padding: 10px 0;
      min-width: 200px;
      z-index: 1000;
      display: none;
    }

    .user-menu-dropdown.show {
      display: block;
    }

    .user-menu-item {
      padding: 8px 15px;
      display: block;
      text-decoration: none;
      color: var(--dark);
      transition: background-color 0.3s;
    }

    .user-menu-item:hover {
      background-color: #f8f9fa;
    }

    .user-menu-item.logout {
      color: var(--danger);
    }

    /* חדש - תמיכה בסידור המשימות */
    .task-sort {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .task-sort select {
      margin-bottom: 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .project-list {
        grid-template-columns: 1fr;
      }

      .row {
        flex-direction: column;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .dashboard-header .btn {
        margin-top: 10px;
        width: 100%;
      }

      .dashboard-filter {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- לוודר לטעינה -->
  <div id="loader" class="loader-container">
    <div class="loader"></div>
  </div>

  <!-- אזור התחברות -->
  <div id="auth-section" class="auth-container hidden">
    <div class="auth-card">
      <h1 style="text-align: center; margin-bottom: 20px; color: var(--primary);">מערכת ניהול פרויקטים</h1>
      <div id="auth-error" style="color: var(--danger); margin-bottom: 15px; display: none; padding: 10px; background-color: #f8d7da; border-radius: 4px;"></div>

      <div class="form-group">
        <label for="email">אימייל:</label>
        <input type="email" id="email" placeholder="הכנס אימייל">
      </div>

      <div class="form-group">
        <label for="password">סיסמה:</label>
        <input type="password" id="password" placeholder="הכנס סיסמה">
      </div>

      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="login-btn" class="btn btn-lg" style="flex: 1;">התחברות</button>
        <button id="register-btn" class="btn btn-success btn-lg" style="flex: 1;">הרשמה</button>
      </div>
    </div>
  </div>

  <!-- אזור האפליקציה -->
  <div id="app-section" class="hidden">
    <!-- סרגל ניווט -->
    <div class="navbar">
      <div class="navbar-container">
        <a href="#" class="navbar-brand">ניהול פרויקטים</a>
        <div class="navbar-nav">
          <div class="nav-item">
            <a href="#" id="nav-projects" class="nav-link active">פרויקטים</a>
          </div>
          <div class="nav-item">
            <a href="#" id="nav-dashboard" class="nav-link">המשימות שלי</a>
          </div>
          <div class="user-menu">
            <div class="user-menu-toggle">
              <div class="user-avatar" id="user-avatar"></div>
              <span id="user-email"></span>
              <i class="fas fa-angle-down"></i>
            </div>
            <div class="user-menu-dropdown">
              <a href="#" class="user-menu-item">הפרופיל שלי</a>
              <a href="#" class="user-menu-item">הגדרות</a>
              <a href="#" id="logout-btn" class="user-menu-item logout">התנתק</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- תצוגת רשימת פרויקטים -->
      <div id="projects-view">
        <div class="dashboard-header">
          <h2>הפרויקטים שלי</h2>
          <button id="add-project-btn" class="btn btn-success">
            <i class="fas fa-plus"></i> פרויקט חדש
          </button>
        </div>

        <div class="tabs">
          <div class="tab active" data-filter="all">כל הפרויקטים</div>
          <div class="tab" data-filter="personal">פרויקטים אישיים</div>
          <div class="tab" data-filter="team">פרויקטים צוותיים</div>
        </div>

        <div id="projects-list" class="project-list">
          <!-- פרויקטים יוצגו כאן -->
          <div>טוען פרויקטים...</div>
        </div>
      </div>

      <!-- תצוגת דשבורד המשימות -->
      <div id="dashboard-view" class="hidden">
        <div class="dashboard-header">
          <h2>המשימות שלי</h2>
        </div>

        <div class="dashboard-filter">
          <select id="dashboard-filter-project" class="form-control">
            <option value="all">כל הפרויקטים</option>
            <!-- אפשרויות יתווספו דינמית -->
          </select>
          <select id="dashboard-sort-by" class="form-control">
            <option value="deadline">מיון לפי תאריך</option>
            <option value="name">מיון לפי שם</option>
            <option value="project">מיון לפי פרויקט</option>
          </select>
          <select id="dashboard-filter-tag" class="form-control">
            <option value="all">כל התגיות</option>
            <!-- תגיות יתווספו דינמית -->
          </select>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">משימות לביצוע</h3>
          </div>
          <div id="dashboard-tasks" class="task-list">
            <!-- המשימות יוצגו כאן -->
          </div>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">משימות שהושלמו</h3>
          </div>
          <div id="dashboard-completed-tasks" class="task-list">
            <!-- המשימות שהושלמו יוצגו כאן -->
          </div>
        </div>

        <div class="dashboard-section">
          <div class="section-header">
            <h3 class="section-title">
              בקשות עזרה צוותית
              <span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i></span>
            </h3>
          </div>
          <div id="dashboard-help-tasks" class="task-list">
            <!-- בקשות העזרה יוצגו כאן -->
          </div>
        </div>
      </div>

      <!-- תצוגת פרויקט ספציפי -->
      <div id="project-detail-view" class="hidden">
        <div class="card">
          <button id="back-to-projects" class="btn">
            <i class="fas fa-arrow-right"></i> חזרה לרשימת הפרויקטים
          </button>

          <div id="project-detail" style="margin-top: 20px;">
            <!-- פרטי הפרויקט יוצגו כאן -->
          </div>

          <!-- חברי צוות לפרויקט צוותי -->
          <div id="team-members-section" class="hidden" style="margin-top: 20px;">
            <div class="section-header">
              <h3 class="section-title">חברי צוות</h3>
              <button id="add-member-btn" class="btn btn-success">
                <i class="fas fa-user-plus"></i> הוסף חבר צוות
              </button>
            </div>
            <div id="team-members-list" class="member-list">
              <!-- חברי צוות יוצגו כאן -->
            </div>
          </div>

          <div style="margin-top: 20px;">
            <div class="section-header">
              <h3 class="section-title">משימות</h3>
              <div>
                <button id="add-task-btn" class="btn">
                  <i class="fas fa-plus"></i> הוסף משימה
                </button>
                <button id="add-help-request-btn" class="btn btn-warning">
                  <i class="fas fa-hands-helping"></i> בקשת עזרה
                </button>
              </div>
            </div>

            <div class="task-sort">
              <select id="task-sort-by" class="form-control">
                <option value="createdAt-desc">חדש לישן</option>
                <option value="createdAt-asc">ישן לחדש</option>
                <option value="deadline-asc">תאריך הקרוב ביותר</option>
                <option value="name-asc">לפי שם (א-ת)</option>
              </select>
              <select id="task-filter-tag" class="form-control">
                <option value="all">כל התגיות</option>
                <!-- תגיות יתווספו דינמית -->
              </select>
            </div>

            <div id="tasks-list" class="task-list">
              <!-- משימות יוצגו כאן -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל פרויקט -->
  <div id="project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="project-modal-title" class="modal-title">פרויקט חדש</h3>
        <span class="modal-close">&times;</span>
      </div>

      <div class="form-group">
        <label for="project-name">שם הפרויקט:</label>
        <input type="text" id="project-name" placeholder="הזן שם לפרויקט">
      </div>

      <div class="form-group">
        <label for="project-description">תיאור הפרויקט:</label>
        <textarea id="project-description" placeholder="הזן תיאור לפרויקט" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="project-deadline">תאריך יעד:</label>
        <input type="date" id="project-deadline">
      </div>

      <div class="form-group">
        <label for="project-type">סוג פרויקט:</label>
        <select id="project-type">
          <option value="personal">פרויקט אישי</option>
          <option value="team">פרויקט צוותי</option>
        </select>
      </div>

      <input type="hidden" id="project-id">

      <div class="modal-footer">
        <button id="save-project-btn" class="btn btn-success">שמור</button>
        <button id="cancel-project-btn" class="btn btn-outline">ביטול</button>
      </div>
    </div>
  </div>

  <!-- מודל חבר צוות -->
  <div id="team-member-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
            <h3 class="modal-title">הוספת חבר צוות לפרויקט</h3>
            <span class="modal-close">&times;</span>
          </div>

          <div class="form-group">
            <label for="member-email">אימייל:</label>
            <input type="email" id="member-email" placeholder="הזן אימייל של חבר צוות">
          </div>

          <div id="member-search-results"></div>

          <div class="modal-footer">
            <button id="add-member-confirm-btn" class="btn btn-success" disabled>הוסף לפרויקט</button>
            <button id="cancel-member-btn" class="btn btn-outline">ביטול</button>
          </div>
        </div>
      </div>

      <!-- מודל משימה -->
      <div id="task-modal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="task-modal-title" class="modal-title">משימה חדשה</h3>
            <span class="modal-close">&times;</span>
          </div>

          <div class="form-group">
            <label for="task-name">שם המשימה:</label>
            <input type="text" id="task-name" placeholder="הזן שם למשימה">
          </div>

          <div class="form-group">
            <label for="task-description">תיאור המשימה:</label>
            <textarea id="task-description" placeholder="הזן תיאור למשימה" rows="4"></textarea>
          </div>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label for="task-deadline">תאריך יעד:</label>
                <input type="date" id="task-deadline">
              </div>
            </div>
            <div class="col">
              <div class="form-group" id="task-tags-container">
                <label for="task-tags">תגיות:</label>
                <div class="tags-input">
                  <div id="task-tags-items"></div>
                  <input type="text" id="task-tag-input" class="tag-input" placeholder="הוסף תגית ולחץ Enter">
                </div>
              </div>
            </div>
          </div>

          <div id="task-assignee-section" class="form-group hidden">
            <label for="task-assignee">שייך ל:</label>
            <select id="task-assignee">
              <option value="">לא משויך</option>
              <!-- אפשרויות חברי צוות יתווספו דינמית -->
            </select>
          </div>

          <div id="task-help-section" class="form-group hidden">
            <div class="form-group">
              <label>
                <input type="checkbox" id="task-help-request">
                בקשת עזרה צוותית
              </label>
            </div>
          </div>

          <input type="hidden" id="task-id">
          <input type="hidden" id="task-project-id">
          <input type="hidden" id="task-tags-hidden">

          <div class="modal-footer">
            <button id="save-task-btn" class="btn btn-success">שמור</button>
            <button id="cancel-task-btn" class="btn btn-outline">ביטול</button>
          </div>
        </div>
      </div>

      <!-- ספריות Firebase -->
      <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

      <script>
        // תצורת Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyC-AfsI6uqslEzbkW-rVPcGObo7TrRFOvs",
          authDomain: "progman-a47d6.firebaseapp.com",
          projectId: "progman-a47d6",
          storageBucket: "progman-a47d6.firebasestorage.app",
          messagingSenderId: "702321893505",
          appId: "1:702321893505:web:81175e361f953973ab6d80",
          measurementId: "G-F4Q6LY8FYE"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);

        // קיצורי דרך לשירותים
        const auth = firebase.auth();
        const db = firebase.firestore();

        // משתנים גלובליים
        let currentUser = null;
        let currentProjectId = null;
        let currentProjectData = null;
        let currentProjectMembers = [];
        let currentFilter = "all";
        let allTags = new Set();
        let allProjects = [];
        let userDashboardTasks = [];

        // הסתרת החלקים ב-DOM עד לקבלת סטטוס החיבור של המשתמש
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-section').classList.add('hidden');

        // הצגת והסתרת לוודר
        function showLoader() {
          document.getElementById('loader').classList.remove('hidden');
        }

        function hideLoader() {
          document.getElementById('loader').classList.add('hidden');
        }

        // אירועי לחיצה - אימות
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('register-btn').addEventListener('click', register);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // אירועי לחיצה - ניווט
        document.getElementById('nav-projects').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-projects').classList.add('active');
          document.getElementById('nav-dashboard').classList.remove('active');
          document.getElementById('projects-view').classList.remove('hidden');
          document.getElementById('dashboard-view').classList.add('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
        });

        document.getElementById('nav-dashboard').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('nav-dashboard').classList.add('active');
          document.getElementById('nav-projects').classList.remove('active');
          document.getElementById('projects-view').classList.add('hidden');
          document.getElementById('dashboard-view').classList.remove('hidden');
          document.getElementById('project-detail-view').classList.add('hidden');
          loadDashboard();
        });

        // Toggle user menu
        document.querySelector('.user-menu-toggle').addEventListener('click', function() {
          document.querySelector('.user-menu-dropdown').classList.toggle('show');
        });

        // Close user menu when clicking outside
        window.addEventListener('click', function(e) {
          if (!e.target.closest('.user-menu')) {
            const dropdown = document.querySelector('.user-menu-dropdown');
            if (dropdown.classList.contains('show')) {
              dropdown.classList.remove('show');
            }
          }
        });

        // אירועי לחיצה - פרויקטים
        document.getElementById('add-project-btn').addEventListener('click', showAddProjectModal);
        document.getElementById('save-project-btn').addEventListener('click', saveProject);
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
          document.getElementById('project-modal').style.display = 'none';
        });

        // אירועי לחיצה - חברי צוות
        document.getElementById('add-member-btn').addEventListener('click', showAddMemberModal);
        document.getElementById('add-member-confirm-btn').addEventListener('click', addMemberToProject);
        document.getElementById('cancel-member-btn').addEventListener('click', () => {
          document.getElementById('team-member-modal').style.display = 'none';
        });

        // אירועי לחיצה - חיפוש חברי צוות לפי הקלדה
        document.getElementById('member-email').addEventListener('input', searchUserByEmail);

        // אירועי לחיצה - משימות
        document.getElementById('add-task-btn').addEventListener('click', () => showAddTaskModal(false));
        document.getElementById('add-help-request-btn').addEventListener('click', () => showAddTaskModal(true));
        document.getElementById('save-task-btn').addEventListener('click', saveTask);
        document.getElementById('cancel-task-btn').addEventListener('click', () => {
          document.getElementById('task-modal').style.display = 'none';
        });

        // אירוע לתגיות
        document.getElementById('task-tag-input').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && this.value.trim() !== '') {
            e.preventDefault();
            addTag(this.value.trim());
            this.value = '';
          }
        });

        // סגירת מודלים בX
        document.querySelectorAll('.modal-close').forEach(close => {
          close.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
          });
        });

        // אירועי סינון דשבורד
        document.getElementById('dashboard-filter-project').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-sort-by').addEventListener('change', filterDashboardTasks);
        document.getElementById('dashboard-filter-tag').addEventListener('change', filterDashboardTasks);

        // אירועי מיון משימות בפרויקט
        document.getElementById('task-sort-by').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        document.getElementById('task-filter-tag').addEventListener('change', function() {
          loadTasks(currentProjectId);
        });

        // אירוע חזרה לרשימת פרויקטים
        document.getElementById('back-to-projects').addEventListener('click', () => {
          document.getElementById('projects-view').style.display = 'block';
          document.getElementById('project-detail-view').style.display = 'none';
          document.getElementById('nav-projects').classList.add('active');
          document.getElementById('nav-dashboard').classList.remove('active');
        });

        // אירועי טאבים לסינון פרויקטים
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.filter;
            loadProjects();
          });
        });

        // מעקב אחר מצב התחברות המשתמש
        auth.onAuthStateChanged(user => {
          if (user) {
            // המשתמש מחובר
            currentUser = {
              uid: user.uid,
              email: user.email
            };

            // עדכון ממשק המשתמש
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();

            // שמירת המידע על המשתמש אם עוד לא קיים
            ensureUserIsRegistered(user.email, user.uid);

            // טעינת הפרויקטים של המשתמש
            loadProjects();
          } else {
            // המשתמש לא מחובר
            currentUser = null;
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('auth-error').style.display = 'none';
          }

          // הסתרת הלוודר בכל מקרה
          hideLoader();
        });

        // וידוא שהמשתמש רשום במערכת
        function ensureUserIsRegistered(email, uid) {
          // בדיקה אם המשתמש כבר רשום במערכת
          db.collection('users').doc(uid).get()
            .then(doc => {
              if (!doc.exists) {
                // הוספת המשתמש למערכת
                return db.collection('users').doc(uid).set({
                  userId: uid,
                  email: email,
                  displayName: email.split('@')[0], // שם תצוגה ברירת מחדל
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            })
            .catch(error => {
              console.error("Error checking user:", error);
            });
        }

        // פונקציות אימות
        function login() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          if (!email || !password) {
            showAuthError('אנא הזן אימייל וסיסמה');
            return;
          }

          showLoader();
          auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
              hideLoader();
              console.error("Login error:", error);
              showAuthError('שגיאה בהתחברות: ' + error.message);
            });
        }

        function register() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          if (!email || !password) {
            showAuthError('אנא הזן אימייל וסיסמה');
            return;
          }

          if (password.length < 6) {
            showAuthError('הסיסמה חייבת להכיל לפחות 6 תווים');
            return;
          }

          showLoader();
          auth.createUserWithEmailAndPassword(email, password)
            .catch(error => {
              hideLoader();
              console.error("Registration error:", error);
              showAuthError('שגיאה בהרשמה: ' + error.message);
            });
        }

        function logout() {
          showLoader();
          auth.signOut()
            .catch(error => {
              hideLoader();
              console.error("Logout error:", error);
            });
        }

        function showAuthError(message) {
          const errorElement = document.getElementById('auth-error');
          errorElement.textContent = message;
          errorElement.style.display = 'block';
        }
        // פונקציות תגיות
    function addTag(tagName) {
      const tagsContainer = document.getElementById('task-tags-items');
      const existingTags = Array.from(tagsContainer.querySelectorAll('.tag-item')).map(tag =>
        tag.textContent.replace('×', '').trim()
      );

      if (existingTags.includes(tagName)) {
        return; // מניעת כפילויות
      }

      const tagElement = document.createElement('div');
      tagElement.className = 'tag-item';
      tagElement.innerHTML = `
        ${tagName}
        <span class="tag-close">×</span>
      `;

      tagElement.querySelector('.tag-close').addEventListener('click', function() {
        tagElement.remove();
        updateTagsHiddenField();
      });

      tagsContainer.appendChild(tagElement);
      updateTagsHiddenField();
    }

    function updateTagsHiddenField() {
      const tagsContainer = document.getElementById('task-tags-items');
      const tags = Array.from(tagsContainer.querySelectorAll('.tag-item')).map(tag =>
        tag.textContent.replace('×', '').trim()
      );

      document.getElementById('task-tags-hidden').value = JSON.stringify(tags);
    }

    function loadTagsToInput(tags) {
      const tagsContainer = document.getElementById('task-tags-items');
      tagsContainer.innerHTML = '';

      if (tags && tags.length > 0) {
        tags.forEach(tag => addTag(tag));
      }
    }

    // פונקציה להוספת חבר צוות
    function showAddMemberModal() {
      document.getElementById('member-email').value = '';
      document.getElementById('member-search-results').innerHTML = '';
      document.getElementById('add-member-confirm-btn').disabled = true;
      document.getElementById('team-member-modal').style.display = 'block';
    }

    // פונקציות מסך דשבורד
    function loadDashboard() {
      showLoader();

      // ראשית טען את כל הפרויקטים עבור הסינון
      updateProjectsDropdown();

      // טעינת המשימות של המשתמש
      Promise.all([
        // משימות שהמשתמש אחראי עליהן
        db.collection('tasks')
          .where('assigneeId', '==', currentUser.uid)
          .get(),

        // משימות בפרויקטים אישיים של המשתמש
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .get();
          }),

        // משימות שהן בקשות עזרה בפרויקטים של המשתמש
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .get()
          .then(projectsSnapshot => {
            const projectIds = projectsSnapshot.docs.map(doc => doc.id);
            if (projectIds.length === 0) return { docs: [] };

            return db.collection('tasks')
              .where('projectId', 'in', projectIds)
              .where('isHelpRequest', '==', true)
              .get();
          }),

        // בקשות עזרה בפרויקטים שהמשתמש חבר בהם
        db.collection('project_members')
          .where('userId', '==', currentUser.uid)
          .get()
          .then(membershipsSnapshot => {
            const projectIds = membershipsSnapshot.docs.map(doc => doc.data().projectId);
            if (projectIds.length === 0) return { docs: [] };

            // Firebase מגביל queries ל-10 ערכים ב-in לכל היותר
            const projectBatches = [];
            for (let i = 0; i < projectIds.length; i += 10) {
              const batch = projectIds.slice(i, i + 10);
              projectBatches.push(batch);
            }

            const queries = projectBatches.map(batch =>
              db.collection('tasks')
                .where('projectId', 'in', batch)
                .where('isHelpRequest', '==', true)
                .get()
            );

            return Promise.all(queries).then(results => {
              // מיזוג התוצאות מכל ה-queries
              const mergedDocs = [];
              results.forEach(result => {
                result.docs.forEach(doc => mergedDocs.push(doc));
              });
              return { docs: mergedDocs };
            });
          })
      ])
      .then(([assignedTasks, personalTasks, ownedHelpTasks, memberHelpTasks]) => {
        // איחוד כל המשימות ומניעת כפילויות
        const uniqueTasks = new Map();

        function addToMap(snapshot, source) {
          snapshot.docs.forEach(doc => {
            if (!uniqueTasks.has(doc.id)) {
              const taskData = doc.data();
              uniqueTasks.set(doc.id, {
                id: doc.id,
                data: taskData,
                source: source
              });

              // שמירת תגיות לסינון
              if (taskData.tags && taskData.tags.length > 0) {
                taskData.tags.forEach(tag => allTags.add(tag));
              }
            }
          });
        }

        addToMap(assignedTasks, 'assigned');
        addToMap(personalTasks, 'personal');
        addToMap(ownedHelpTasks, 'ownedHelp');
        addToMap(memberHelpTasks, 'memberHelp');

        // שמירת המשימות במשתנה גלובלי
        userDashboardTasks = Array.from(uniqueTasks.values());

        // עדכון הסינון של תגיות
        updateTagsDropdown();

        // הצגת המשימות בדשבורד
        filterDashboardTasks();

        hideLoader();
      })
      .catch(error => {
        console.error("Error loading dashboard:", error);
        hideLoader();
        alert("שגיאה בטעינת המשימות");
      });
    }

    function updateProjectsDropdown() {
      const projectSelect = document.getElementById('dashboard-filter-project');
      projectSelect.innerHTML = '<option value="all">כל הפרויקטים</option>';

      allProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.data.name;
        projectSelect.appendChild(option);
      });
    }

    function updateTagsDropdown() {
      const tagSelect = document.getElementById('dashboard-filter-tag');
      tagSelect.innerHTML = '<option value="all">כל התגיות</option>';

      allTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        tagSelect.appendChild(option);
      });
    }

    function filterDashboardTasks() {
      const projectFilter = document.getElementById('dashboard-filter-project').value;
      const sortBy = document.getElementById('dashboard-sort-by').value;
      const tagFilter = document.getElementById('dashboard-filter-tag').value;

      // סינון המשימות
      let filteredTasks = userDashboardTasks.filter(task => {
        // סינון לפי פרויקט
        if (projectFilter !== 'all' && task.data.projectId !== projectFilter) {
          return false;
        }

        // סינון לפי תגית
        if (tagFilter !== 'all') {
          const taskTags = task.data.tags || [];
          return taskTags.includes(tagFilter);
        }

        return true;
      });

      // מיון המשימות
      filteredTasks.sort((a, b) => {
        switch (sortBy) {
          case 'deadline':
            // אם אין תאריך, לשים בסוף
            if (!a.data.deadline) return 1;
            if (!b.data.deadline) return -1;
            return new Date(a.data.deadline) - new Date(b.data.deadline);
          case 'name':
            return a.data.name.localeCompare(b.data.name);
          case 'project':
            const projectA = allProjects.find(p => p.id === a.data.projectId);
            const projectB = allProjects.find(p => p.id === b.data.projectId);
            return (projectA?.data.name || '').localeCompare(projectB?.data.name || '');
          default:
            return 0;
        }
      });

      // הצגת המשימות
      displayDashboardTasks(filteredTasks);
    }

    function displayDashboardTasks(tasks) {
      const pendingTasksContainer = document.getElementById('dashboard-tasks');
      const completedTasksContainer = document.getElementById('dashboard-completed-tasks');
      const helpTasksContainer = document.getElementById('dashboard-help-tasks');

      pendingTasksContainer.innerHTML = '';
      completedTasksContainer.innerHTML = '';
      helpTasksContainer.innerHTML = '';

      // בדיקה אם יש משימות
      if (tasks.length === 0) {
        pendingTasksContainer.innerHTML = '<div>אין משימות לתצוגה.</div>';
        completedTasksContainer.innerHTML = '<div>אין משימות שהושלמו.</div>';
        helpTasksContainer.innerHTML = '<div>אין בקשות עזרה.</div>';
        return;
      }

      // סינון המשימות לפי סוג
      const pendingTasks = tasks.filter(task => !task.data.completed && !task.data.isHelpRequest);
      const completedTasks = tasks.filter(task => task.data.completed);
      const helpTasks = tasks.filter(task => task.data.isHelpRequest && !task.data.completed);

      // הצגת המשימות הפתוחות
      if (pendingTasks.length === 0) {
        pendingTasksContainer.innerHTML = '<div>אין משימות לביצוע.</div>';
      } else {
        pendingTasks.forEach(task => {
          pendingTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }

      // הצגת המשימות שהושלמו
      if (completedTasks.length === 0) {
        completedTasksContainer.innerHTML = '<div>אין משימות שהושלמו.</div>';
      } else {
        completedTasks.forEach(task => {
          completedTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }

      // הצגת בקשות העזרה
      if (helpTasks.length === 0) {
        helpTasksContainer.innerHTML = '<div>אין בקשות עזרה כרגע.</div>';
      } else {
        helpTasks.forEach(task => {
          helpTasksContainer.appendChild(createDashboardTaskElement(task));
        });
      }
    }

    function createDashboardTaskElement(task) {
      const project = allProjects.find(p => p.id === task.data.projectId) || { data: { name: 'פרויקט לא ידוע' } };

      const taskElement = document.createElement('div');
      taskElement.className = `task-item ${task.data.completed ? 'completed' : ''} ${task.data.isHelpRequest ? 'help-request' : ''}`;

      // בדיקת תאריך יעד חלף
      let dueDateClass = '';
      let dueDateText = 'אין תאריך יעד';

      if (task.data.deadline) {
        const dueDate = new Date(task.data.deadline);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (dueDate < today && !task.data.completed) {
          dueDateClass = 'overdue';
        }

        dueDateText = dueDate.toLocaleDateString('he-IL');
      }

      // יצירת תגיות
      let tagsHtml = '';
      if (task.data.tags && task.data.tags.length > 0) {
        tagsHtml = '<div class="tags-container">';
        task.data.tags.forEach(tag => {
          const tagClass = getTagColorClass(tag);
          tagsHtml += `<span class="tag ${tagClass}">${tag}</span>`;
        });
        tagsHtml += '</div>';
      }

      taskElement.innerHTML = `
        <div style="display: flex; align-items: center;">
          <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.data.completed ? 'checked' : ''} style="transform: scale(1.2); margin-left: 10px;">
          <div class="task-content">
            <h4 class="task-title">${task.data.name}</h4>
            <div class="task-description">${task.data.description || 'אין תיאור'}</div>
            <div class="task-meta">
              <span><i class="fas fa-briefcase"></i> ${project.data?.name || 'פרויקט לא ידוע'}</span>
              <span class="task-due-date ${dueDateClass}"><i class="fas fa-calendar-alt"></i> ${dueDateText}</span>
              ${task.data.isHelpRequest ? '<span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i> בקשת עזרה</span>' : ''}
            </div>
            ${tagsHtml}
          </div>
        </div>
        <div class="task-actions">
          <button class="btn btn-sm view-task" data-project-id="${task.data.projectId}" data-task-id="${task.id}">
            <i class="fas fa-eye"></i>
          </button>
          ${task.data.isHelpRequest && !task.data.assigneeId ?
            `<button class="btn btn-sm btn-warning take-help-task" data-id="${task.id}">
              <i class="fas fa-hand-holding-heart"></i> קח משימה
             </button>` : ''}
        </div>
      `;

      // הוספת אירועים
      taskElement.querySelector('.task-checkbox').addEventListener('change', function() {
        updateTaskStatus(task.id, this.checked);
      });

      taskElement.querySelector('.view-task').addEventListener('click', function() {
        // מעבר לתצוגת הפרויקט ופתיחת המשימה
        openProject(this.dataset.projectId, null, this.dataset.taskId);
      });

      // אירוע לקיחת משימת עזרה
      const takeHelpButton = taskElement.querySelector('.take-help-task');
      if (takeHelpButton) {
        takeHelpButton.addEventListener('click', function() {
          takeHelpTask(this.dataset.id);
        });
      }

      return taskElement;
    }

    function getTagColorClass(tag) {
      // מתן צבע לתגית לפי השם
      const tagLower = tag.toLowerCase();

      if (tagLower.includes('דחוף') || tagLower.includes('חשוב')) {
        return 'tag-red';
      } else if (tagLower.includes('בינוני')) {
        return 'tag-yellow';
      } else if (tagLower.includes('נמוך')) {
        return 'tag-green';
      } else if (tagLower.includes('באג') || tagLower.includes('תקלה')) {
        return 'tag-red';
      } else if (tagLower.includes('פיתוח')) {
        return 'tag-blue';
      } else if (tagLower.includes('עיצוב')) {
        return 'tag-purple';
      } else if (tagLower.includes('תוכן')) {
        return 'tag-cyan';
      }

      // אם אין התאמה ספציפית, להחזיר צבע לפי hash של השם
      const hash = tag.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 6;

      const colors = ['tag-blue', 'tag-green', 'tag-red', 'tag-yellow', 'tag-purple', 'tag-cyan'];
      return colors[hash];
    }

    function takeHelpTask(taskId) {
      if (!confirm('האם אתה בטוח שברצונך לקחת את המשימה?')) {
        return;
      }

      showLoader();

      db.collection('tasks').doc(taskId).update({
        assigneeId: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        hideLoader();
        loadDashboard(); // רענון הדשבורד
        alert('המשימה נוספה למשימות שלך');
      })
      .catch(error => {
        hideLoader();
        console.error("Error taking help task:", error);
        alert('שגיאה בלקיחת המשימה');
      });
    }

    // חיפוש משתמש לפי אימייל
    function searchUserByEmail() {
      const email = document.getElementById('member-email').value.trim().toLowerCase();
      const resultsDiv = document.getElementById('member-search-results');

      if (!email) {
        resultsDiv.innerHTML = '';
        return;
      }

      resultsDiv.innerHTML = '<div class="text-center">מחפש משתמש...</div>';

      db.collection('users')
        .where('email', '==', email)
        .limit(1)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            resultsDiv.innerHTML = '<div style="color: var(--danger); padding: 10px; background-color: #f8d7da; border-radius: 4px; margin-top: 10px;">משתמש לא נמצא. הזמן אותו להירשם למערכת.</div>';
            return;
          }

          const user = snapshot.docs[0].data();
          resultsDiv.innerHTML = `
            <div style="background-color: #f0f0f0; padding: 15px; border-radius: var(--radius); margin-top: 15px;">
              <div style="font-weight: 500; font-size: 16px;">${user.displayName || user.email}</div>
              <div style="color: #666;">${user.email}</div>
            </div>
          `;

          // בדיקה אם המשתמש כבר בפרויקט
          const isMember = currentProjectMembers.some(member => member.userId === snapshot.docs[0].id);

          if (isMember) {
            resultsDiv.innerHTML += '<div style="color: var(--warning); margin-top: 10px;">משתמש זה כבר חבר בפרויקט</div>';
            document.getElementById('add-member-confirm-btn').disabled = true;
          } else {
            document.getElementById('add-member-confirm-btn').disabled = false;
          }
        })
        .catch(error => {
          console.error("Error searching for user:", error);
          resultsDiv.innerHTML = '<div style="color: var(--danger);">שגיאה בחיפוש משתמש</div>';
        });
    }

    // הוספת חבר לפרויקט
    function addMemberToProject() {
      const email = document.getElementById('member-email').value.trim().toLowerCase();

      if (!email) {
        alert('אנא הזן אימייל');
        return;
      }

      showLoader();

      // מציאת המשתמש לפי האימייל
      db.collection('users')
        .where('email', '==', email)
        .limit(1)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            hideLoader();
            alert('משתמש לא נמצא');
            return;
          }

          const memberDoc = snapshot.docs[0];
          const memberId = memberDoc.id;
          const memberData = memberDoc.data();

          // בדיקה אם המשתמש כבר קיים בפרויקט
          if (currentProjectMembers.some(member => member.userId === memberId)) {
            hideLoader();
            alert('משתמש זה כבר קיים בפרויקט');
            return;
          }

          // הוספת המשתמש לרשימת החברים של הפרויקט
          db.collection('project_members').add({
            projectId: currentProjectId,
            userId: memberId,
            email: memberData.email,
            displayName: memberData.displayName || memberData.email.split('@')[0],
            role: 'member',
            addedBy: currentUser.uid,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(() => {
            hideLoader();
            document.getElementById('team-member-modal').style.display = 'none';
            loadProjectMembers(currentProjectId);
          })
          .catch(error => {
            hideLoader();
            console.error("Error adding team member:", error);
            alert('שגיאה בהוספת חבר צוות');
          });
        })
        .catch(error => {
          hideLoader();
          console.error("Error searching for user:", error);
          alert('שגיאה בחיפוש משתמש');
        });
    }
    // פונקציות פרויקטים
    function loadProjects() {
      showLoader();
      const projectsList = document.getElementById('projects-list');
      projectsList.innerHTML = '<div>טוען פרויקטים...</div>';

      // הכנת השאילתות בהתאם לסוג הפרויקט
      let projectsQuery;

      if (currentFilter === "all") {
        // שליפת כל הפרויקטים: אישיים של המשתמש וצוותיים שהוא חבר בהם
        Promise.all([
          // פרויקטים אישיים
          db.collection('projects')
            .where('userId', '==', currentUser.uid)
            .where('type', '==', 'personal')
            .orderBy('createdAt', 'desc')
            .get(),

          // פרויקטים צוותיים שהמשתמש יצר
          db.collection('projects')
            .where('userId', '==', currentUser.uid)
            .where('type', '==', 'team')
            .orderBy('createdAt', 'desc')
            .get(),

          // פרויקטים צוותיים שהמשתמש חבר בהם
          db.collection('project_members')
            .where('userId', '==', currentUser.uid)
            .get()
        ])
        .then(async ([personalProjects, teamProjects, teamMemberships]) => {
          let allProjectsList = [];

          // הוספת פרויקטים אישיים
          personalProjects.forEach(doc => {
            const project = doc.data();
            allProjectsList.push({
              id: doc.id,
              data: project,
              role: 'owner',
              type: 'personal'
            });
          });

          // הוספת פרויקטים צוותיים שהמשתמש יצר
          teamProjects.forEach(doc => {
            const project = doc.data();
            allProjectsList.push({
              id: doc.id,
              data: project,
              role: 'owner',
              type: 'team'
            });
          });

          // הוספת פרויקטים צוותיים שהמשתמש חבר בהם
          const projectIds = teamMemberships.docs.map(doc => doc.data().projectId);

          if (projectIds.length > 0) {
            const teamProjectsChunks = [];

            // שליפת הפרויקטים ב-chunks של 10 (מגבלת Firebase)
            for (let i = 0; i < projectIds.length; i += 10) {
              const chunk = projectIds.slice(i, i + 10);
              teamProjectsChunks.push(chunk);
            }

            for (const chunk of teamProjectsChunks) {
              const projectsSnapshot = await db.collection('projects')
                .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
                .get();

              projectsSnapshot.forEach(doc => {
                // בדיקה שהפרויקט הזה עוד לא קיים ברשימה
                if (!allProjectsList.some(p => p.id === doc.id)) {
                  const project = doc.data();
                  const membership = teamMemberships.docs.find(m => m.data().projectId === doc.id);
                  const role = membership ? membership.data().role : 'member';

                  allProjectsList.push({
                    id: doc.id,
                    data: project,
                    role: role,
                    type: 'team'
                  });
                }
              });
            }
          }

          // שמירת הפרויקטים במשתנה גלובלי
          allProjects = allProjectsList;
          displayProjects(allProjectsList);
          hideLoader();
        })
        .catch(error => {
          console.error("Error loading projects:", error);
          projectsList.innerHTML = '<div>שגיאה בטעינת פרויקטים. נסה שוב מאוחר יותר.</div>';
          hideLoader();
        });
      } else if (currentFilter === "personal") {
        // רק פרויקטים אישיים
        db.collection('projects')
          .where('userId', '==', currentUser.uid)
          .where('type', '==', 'personal')
          .orderBy('createdAt', 'desc')
          .get()
          .then(snapshot => {
            const projects = snapshot.docs.map(doc => ({
              id: doc.id,
              data: doc.data(),
              role: 'owner',
              type: 'personal'
            }));

            allProjects = projects;
            displayProjects(projects);
            hideLoader();
          })
          .catch(error => {
            console.error("Error loading personal projects:", error);
            projectsList.innerHTML = '<div>שגיאה בטעינת פרויקטים אישיים. נסה שוב מאוחר יותר.</div>';
            hideLoader();
          });
      } else if (currentFilter === "team") {
        // רק פרויקטים צוותיים (שהמשתמש יצר או חבר בהם)
        Promise.all([
          // פרויקטים צוותיים שהמשתמש יצר
          db.collection('projects')
            .where('userId', '==', currentUser.uid)
            .where('type', '==', 'team')
            .orderBy('createdAt', 'desc')
            .get(),

          // פרויקטים צוותיים שהמשתמש חבר בהם
          db.collection('project_members')
            .where('userId', '==', currentUser.uid)
            .get()
        ])
        .then(async ([ownedProjects, teamMemberships]) => {
          let allProjectsList = [];

          // הוספת פרויקטים צוותיים שהמשתמש יצר
          ownedProjects.forEach(doc => {
            const project = doc.data();
            allProjectsList.push({
              id: doc.id,
              data: project,
              role: 'owner',
              type: 'team'
            });
          });

          // הוספת פרויקטים צוותיים שהמשתמש חבר בהם
          const projectIds = teamMemberships.docs.map(doc => doc.data().projectId);

          if (projectIds.length > 0) {
            const teamProjectsChunks = [];

            // שליפת הפרויקטים ב-chunks של 10 (מגבלת Firebase)
            for (let i = 0; i < projectIds.length; i += 10) {
              const chunk = projectIds.slice(i, i + 10);
              teamProjectsChunks.push(chunk);
            }

            for (const chunk of teamProjectsChunks) {
              const projectsSnapshot = await db.collection('projects')
                .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
                .get();

              projectsSnapshot.forEach(doc => {
                // בדיקה שהפרויקט הזה עוד לא קיים ברשימה
                if (!allProjectsList.some(p => p.id === doc.id)) {
                  const project = doc.data();
                  const membership = teamMemberships.docs.find(m => m.data().projectId === doc.id);
                  const role = membership ? membership.data().role : 'member';

                  allProjectsList.push({
                    id: doc.id,
                    data: project,
                    role: role,
                    type: 'team'
                  });
                }
              });
            }
          }

          allProjects = allProjectsList;
          displayProjects(allProjectsList);
          hideLoader();
        })
        .catch(error => {
          console.error("Error loading team projects:", error);
          projectsList.innerHTML = '<div>שגיאה בטעינת פרויקטים צוותיים. נסה שוב מאוחר יותר.</div>';
          hideLoader();
        });
      }
    }

    // הצגת הפרויקטים בממשק
    function displayProjects(projects) {
      const projectsList = document.getElementById('projects-list');

      if (projects.length === 0) {
        projectsList.innerHTML = '<div style="text-align: center; padding: 20px;">אין פרויקטים. לחץ על "פרויקט חדש" כדי להתחיל.</div>';
        return;
      }

      projectsList.innerHTML = '';

      projects.forEach(project => {
        const { id, data, role, type } = project;

        // הצגת תאריך בפורמט מקומי
        let deadlineText = 'אין תאריך יעד';
        let isOverdue = false;

        if (data.deadline) {
          const date = new Date(data.deadline);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          deadlineText = date.toLocaleDateString('he-IL');

          if (date < today) {
            isOverdue = true;
          }
        }

        // מחשב את התקדמות המשימות
        const progress = Math.random() * 100; // כרגע אקראי, צריך לחשב באמת לפי המשימות

        // יצירת כרטיס פרויקט
        const projectCard = document.createElement('div');
        projectCard.className = 'card project-card';
        projectCard.style.borderRight = `5px solid ${isOverdue ? 'var(--danger)' : 'var(--primary)'}`;

        // אינדיקטור סוג פרויקט
        const typeIndicator = document.createElement('div');
        typeIndicator.className = `project-type-indicator ${data.type === 'personal' ? 'personal-project' : 'team-project'}`;
        typeIndicator.textContent = data.type === 'personal' ? 'אישי' : 'צוותי';
        projectCard.appendChild(typeIndicator);

        // תוכן הכרטיס
        const cardContent = document.createElement('div');
        cardContent.className = 'project-card-content';
        cardContent.innerHTML = `
          <h3 class="project-card-title">${data.name}</h3>
          <div class="project-card-description">${data.description || 'אין תיאור'}</div>
          <div class="project-card-footer">
            <div>
              <div><i class="fas fa-calendar-alt"></i> ${deadlineText}</div>
              ${role === 'owner' ? '<span class="badge badge-owner">מנהל</span>' : '<span class="badge badge-member">חבר</span>'}
            </div>
            ${role === 'owner' ?
              `<button class="btn btn-sm btn-danger delete-project" data-id="${id}">
                <i class="fas fa-trash"></i>
               </button>` : ''}
          </div>
        `;
        projectCard.appendChild(cardContent);

        // אירוע לחיצה על כרטיס פרויקט
        projectCard.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-project')) {
            openProject(id, role);
          }
        });

        // אירוע מחיקת פרויקט
        const deleteButton = projectCard.querySelector('.delete-project');
        if (deleteButton) {
          deleteButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('האם אתה בטוח שברצונך למחוק פרויקט זה?')) {
              deleteProject(id);
            }
          });
        }

        projectsList.appendChild(projectCard);
      });
    }

    function loadProjectMembers(projectId) {
      const membersList = document.getElementById('team-members-list');
      membersList.innerHTML = '<div>טוען חברי צוות...</div>';

      db.collection('project_members')
        .where('projectId', '==', projectId)
        .get()
        .then(snapshot => {
          if (snapshot.empty && (!currentProjectData || currentProjectData.userId !== currentUser.uid)) {
            membersList.innerHTML = '<div>אין חברי צוות נוספים בפרויקט.</div>';
            currentProjectMembers = [];
            return;
          }

          membersList.innerHTML = '';
          currentProjectMembers = [];

          // הוספת בעל הפרויקט
          if (currentProjectData) {
            currentProjectMembers.push({
              userId: currentProjectData.userId,
              email: currentProjectData.ownerEmail || currentUser.email,
              displayName: currentProjectData.ownerName || currentUser.email.split('@')[0],
              role: 'owner'
            });

            const ownerItem = document.createElement('div');
            ownerItem.className = 'member-item';
            ownerItem.innerHTML = `
              <div>
                <strong>${currentProjectData.ownerName || currentUser.email.split('@')[0]}</strong>
                <div>${currentProjectData.ownerEmail || currentUser.email}</div>
                <span class="badge badge-owner">מנהל פרויקט</span>
              </div>
            `;
            membersList.appendChild(ownerItem);
          }

          // הוספת שאר חברי הצוות
          snapshot.forEach(doc => {
            const member = doc.data();
            const memberId = doc.id;

            currentProjectMembers.push({
              userId: member.userId,
              email: member.email,
              displayName: member.displayName,
              role: member.role
            });

            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
            memberItem.innerHTML = `
              <div>
                <strong>${member.displayName}</strong>
                <div>${member.email}</div>
              </div>
            `;

            // אפשרות הסרת חבר צוות רק לבעל הפרויקט
            if (currentProjectData && currentProjectData.userId === currentUser.uid) {
              const removeButton = document.createElement('button');
              removeButton.className = 'btn btn-sm btn-danger';
              removeButton.innerHTML = '<i class="fas fa-user-minus"></i>';
              removeButton.addEventListener('click', () => {
                if (confirm(`האם להסיר את ${member.displayName} מהפרויקט?`)) {
                  removeTeamMember(memberId);
                }
              });
              memberItem.appendChild(removeButton);
            }

            membersList.appendChild(memberItem);
          });
        })
        .catch(error => {
          console.error("Error loading team members:", error);
          membersList.innerHTML = '<div>שגיאה בטעינת חברי צוות.</div>';
        });
    }

    function removeTeamMember(membershipId) {
      showLoader();

      db.collection('project_members').doc(membershipId).delete()
        .then(() => {
          hideLoader();
          loadProjectMembers(currentProjectId);
        })
        .catch(error => {
          hideLoader();
          console.error("Error removing team member:", error);
          alert("שגיאה בהסרת חבר צוות");
        });
    }

    function openProject(projectId, userRole, taskIdToShow = null) {
      showLoader();
      currentProjectId = projectId;

      // שינוי תצוגה
      document.getElementById('projects-view').style.display = 'none';
      document.getElementById('dashboard-view').style.display = 'none';
      document.getElementById('project-detail-view').style.display = 'block';

      // טעינת פרטי הפרויקט
      db.collection('projects').doc(projectId).get()
        .then(doc => {
          if (!doc.exists) {
            hideLoader();
            alert('הפרויקט לא נמצא');
            return;
          }

          const project = doc.data();
          currentProjectData = project;

          // הצגת תאריך בפורמט מקומי
          let deadlineText = 'אין תאריך יעד';
          let deadlineClass = '';

          if (project.deadline) {
            const date = new Date(project.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            deadlineText = date.toLocaleDateString('he-IL');

            if (date < today) {
              deadlineClass = 'text-danger';
            }
          }

          // הצגת פרטי הפרויקט
          const projectDetail = document.getElementById('project-detail');
          projectDetail.innerHTML = `
            <h2 style="margin-bottom: 15px;">${project.name}</h2>
            <div style="background-color: var(--light); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
              <p style="margin-bottom: 15px;">${project.description || 'אין תיאור'}</p>
              <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div>
                  <strong><i class="fas fa-tag"></i> סוג פרויקט:</strong>
                  <span class="badge ${project.type === 'personal' ? 'personal-project' : 'team-project'}" style="margin-right: 5px;">
                    ${project.type === 'personal' ? 'אישי' : 'צוותי'}
                  </span>
                </div>
                <div>
                  <strong><i class="fas fa-calendar-alt"></i> תאריך יעד:</strong>
                  <span class="${deadlineClass}">${deadlineText}</span>
                </div>
              </div>
            </div>
          `;

          // הוספת כפתור עריכה רק למי שיצר את הפרויקט
          if (project.userId === currentUser.uid) {
            const editButton = document.createElement('button');
            editButton.className = 'btn';
            editButton.innerHTML = '<i class="fas fa-edit"></i> ערוך פרויקט';
            editButton.addEventListener('click', () => {
              showEditProjectModal(projectId, project);
            });
            projectDetail.appendChild(editButton);
          }

          // הצגת חברי צוות רק בפרויקטים צוותיים
          if (project.type === 'team') {
            document.getElementById('team-members-section').style.display = 'block';
            loadProjectMembers(projectId);

            // הסתרת כפתור הוספת חברים אם המשתמש אינו הבעלים של הפרויקט
            document.getElementById('add-member-btn').style.display =
              (project.userId === currentUser.uid) ? 'block' : 'none';
          } else {
            document.getElementById('team-members-section').style.display = 'none';
          }

          // עדכון הסינון לפי תגיות
          updateProjectTaskTagsDropdown(projectId);

          // טעינת המשימות של הפרויקט
          loadTasks(projectId, taskIdToShow);
        })
        .catch(error => {
          hideLoader();
          console.error("Error fetching project:", error);
          alert('שגיאה בטעינת פרטי הפרויקט');
        });
    }

    function updateProjectTaskTagsDropdown(projectId) {
      // טעינת תגיות המשימות של הפרויקט הנוכחי
      db.collection('tasks')
        .where('projectId', '==', projectId)
        .get()
        .then(snapshot => {
          const tags = new Set();

          snapshot.forEach(doc => {
            const task = doc.data();
            if (task.tags && task.tags.length > 0) {
              task.tags.forEach(tag => tags.add(tag));
            }
          });

          // עדכון הדרופדאון
          const tagSelect = document.getElementById('task-filter-tag');
          tagSelect.innerHTML = '<option value="all">כל התגיות</option>';

          tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Error loading project tags:", error);
        });
    }

    function showAddProjectModal() {
      document.getElementById('project-modal-title').textContent = 'פרויקט חדש';
      document.getElementById('project-name').value = '';
      document.getElementById('project-description').value = '';
      document.getElementById('project-deadline').value = '';
      document.getElementById('project-type').value = 'personal';
      document.getElementById('project-type').disabled = false;
      document.getElementById('project-id').value = '';

      document.getElementById('project-modal').style.display = 'block';
    }

    function showEditProjectModal(projectId, project) {
      document.getElementById('project-modal-title').textContent = 'עריכת פרויקט';
      document.getElementById('project-name').value = project.name || '';
      document.getElementById('project-description').value = project.description || '';
      document.getElementById('project-deadline').value = project.deadline || '';
      document.getElementById('project-type').value = project.type || 'personal';
      document.getElementById('project-id').value = projectId;

      // בעריכת פרויקט קיים לא ניתן לשנות את סוג הפרויקט
      document.getElementById('project-type').disabled = true;

      document.getElementById('project-modal').style.display = 'block';
    }

    function saveProject() {
      const name = document.getElementById('project-name').value.trim();
      const description = document.getElementById('project-description').value.trim();
      const deadline = document.getElementById('project-deadline').value;
      const type = document.getElementById('project-type').value;
      const projectId = document.getElementById('project-id').value;

      if (!name) {
        alert('אנא הזן שם לפרויקט');
        return;
      }

      showLoader();

      const projectData = {
        name,
        description,
        deadline,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      let savePromise;

      if (projectId) {
        // עדכון פרויקט קיים - אין לשנות את הסוג
        savePromise = db.collection('projects').doc(projectId).update(projectData);
      } else {
        // יצירת פרויקט חדש
        projectData.userId = currentUser.uid;
        projectData.type = type;
        projectData.ownerEmail = currentUser.email;
        projectData.ownerName = currentUser.email.split('@')[0]; // שם תצוגה בסיסי
        projectData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        savePromise = db.collection('projects').add(projectData);
      }

      savePromise
        .then((result) => {
          hideLoader();
          document.getElementById('project-modal').style.display = 'none';
          document.getElementById('project-type').disabled = false; // החזרת הבחירה למצב פעיל

          if (projectId) {
            // אם זו עריכת פרויקט קיים
            openProject(projectId);
          } else {
            // אם זה פרויקט חדש
            loadProjects();
          }
        })
        .catch(error => {
          hideLoader();
          console.error("Error saving project:", error);
          alert('שגיאה בשמירת פרויקט');
          document.getElementById('project-type').disabled = false;
        });
    }

    function deleteProject(projectId) {
      if (!confirm('האם אתה בטוח שברצונך למחוק פרויקט זה? כל המשימות וחברי הצוות יימחקו.')) {
        return;
      }

      showLoader();

      // ראשית מחיקת כל המשימות השייכות לפרויקט
      db.collection('tasks')
        .where('projectId', '==', projectId)
        .get()
        .then(snapshot => {
          const batch = db.batch();

          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });

          return batch.commit();
        })
        .then(() => {
          // מחיקת חברי הצוות מהפרויקט (אם יש)
          return db.collection('project_members')
            .where('projectId', '==', projectId)
            .get();
        })
        .then(snapshot => {
          const batch = db.batch();

          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });

          return batch.commit();
        })
        .then(() => {
          // מחיקת הפרויקט עצמו
          return db.collection('projects').doc(projectId).delete();
        })
        .then(() => {
          hideLoader();
          // בדיקה אם הפרויקט הנוכחי נמחק
          if (currentProjectId === projectId) {
            document.getElementById('projects-view').style.display = 'block';
            document.getElementById('project-detail-view').style.display = 'none';
            currentProjectId = null;
          }

          // רענון רשימת הפרויקטים
          loadProjects();
        })
        .catch(error => {
          hideLoader();
          console.error("Error deleting project:", error);
          alert('שגיאה במחיקת פרויקט');
        });
    }

    // פונקציות משימות
    function loadTasks(projectId, taskIdToShow = null) {
      const tasksList = document.getElementById('tasks-list');
      tasksList.innerHTML = '<div>טוען משימות...</div>';

      // קבלת פרמטרים של סינון ומיון
      const sortValue = document.getElementById('task-sort-by').value;
      const [sortField, sortDirection] = sortValue.split('-');

      const filterTag = document.getElementById('task-filter-tag').value;

      let query = db.collection('tasks')
        .where('projectId', '==', projectId);

      // הוספת מיון לשאילתא אם אפשר
      if (sortField === 'createdAt') {
        query = query.orderBy(sortField, sortDirection);
      }

      query.get()
        .then(snapshot => {
          if (snapshot.empty) {
            tasksList.innerHTML = '<div style="text-align: center; padding: 15px;">אין משימות בפרויקט זה. לחץ על "הוסף משימה" להוספת משימה חדשה.</div>';
            hideLoader();
            return;
          }

          // איסוף ועיבוד המשימות
          let tasks = snapshot.docs.map(doc => {
            return {
              id: doc.id,
              data: doc.data()
            };
          });

          // מיון במידת הצורך (אם השדה אינו createdAt שכבר מתויג בשאילתא)
          if (sortField !== 'createdAt') {
            tasks.sort((a, b) => {
              let valA = a.data[sortField] || '';
              let valB = b.data[sortField] || '';

              // מיון מיוחד לתאריכים
              if (sortField === 'deadline') {
                valA = valA ? new Date(valA) : new Date(9999, 11, 31);
                valB = valB ? new Date(valB) : new Date(9999, 11, 31);
              }

              if (sortDirection === 'asc') {
                return valA > valB ? 1 : -1;
              } else {
                return valA < valB ? 1 : -1;
              }
            });
          }

          // סינון לפי תגית אם נבחר
          if (filterTag !== 'all') {
            tasks = tasks.filter(task => {
              const tags = task.data.tags || [];
              return tags.includes(filterTag);
            });
          }

          // רנדור המשימות
          tasksList.innerHTML = '';

          tasks.forEach(task => {
            const taskElement = createTaskElement(task);
            tasksList.appendChild(taskElement);
          });

          // אם יש משימה ספציפית להציג
          if (taskIdToShow) {
            const taskToShow = tasks.find(t => t.id === taskIdToShow);
            if (taskToShow) {
              showEditTaskModal(taskIdToShow, taskToShow.data);
            }
          }

          hideLoader();
        })
        .catch(error => {
          hideLoader();
          console.error("Error loading tasks:", error);
          tasksList.innerHTML = '<div>שגיאה בטעינת משימות.</div>';
        });
    }

    function createTaskElement(task) {
      const { id, data } = task;

      // הצגת תאריך בפורמט מקומי
      let deadlineText = 'אין תאריך יעד';
      let isOverdue = false;

      if (data.deadline) {
        const date = new Date(data.deadline);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        deadlineText = date.toLocaleDateString('he-IL');

        if (date < today && !data.completed) {
          isOverdue = true;
        }
      }

      // מידע על האחראי למשימה (רק בפרויקטים צוותיים)
      let assigneeInfo = '';
      if (currentProjectData && currentProjectData.type === 'team' && data.assigneeId) {
        const assignee = currentProjectMembers.find(m => m.userId === data.assigneeId);
          if (assignee) {
            assigneeInfo = `<span class="badge" style="background-color: #e9ecef; color: #495057;"><i class="fas fa-user"></i> ${assignee.displayName}</span>`;
          }
        }

        // יצירת תגיות
        let tagsHtml = '';
        if (data.tags && data.tags.length > 0) {
          tagsHtml = '<div class="tags-container">';
          data.tags.forEach(tag => {
            const tagClass = getTagColorClass(tag);
            tagsHtml += `<span class="tag ${tagClass}">${tag}</span>`;
          });
          tagsHtml += '</div>';
        }

        // יצירת אלמנט משימה
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${data.completed ? 'completed' : ''} ${data.isHelpRequest ? 'help-request' : ''}`;
        taskItem.innerHTML = `
          <div style="display: flex; align-items: center;">
            <input type="checkbox" class="task-checkbox" data-id="${id}" ${data.completed ? 'checked' : ''} style="transform: scale(1.2); margin-left: 10px;">
            <div class="task-content">
              <h4 class="task-title">${data.name}</h4>
              <div class="task-description">${data.description || 'אין תיאור'}</div>
              <div class="task-meta">
                <span class="task-due-date ${isOverdue ? 'overdue' : ''}"><i class="fas fa-calendar-alt"></i> ${deadlineText}</span>
                ${assigneeInfo}
                ${data.isHelpRequest ? '<span class="badge" style="background-color: var(--warning); color: white;"><i class="fas fa-hands-helping"></i> בקשת עזרה</span>' : ''}
              </div>
              ${tagsHtml}
            </div>
          </div>
          <div class="task-actions">
            <button class="btn btn-sm edit-task" data-id="${id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger delete-task" data-id="${id}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;

        // הוספת אירועים
        taskItem.querySelector('.task-checkbox').addEventListener('change', function() {
          updateTaskStatus(id, this.checked);
        });

        taskItem.querySelector('.edit-task').addEventListener('click', function() {
          // קבלת נתוני המשימה
          db.collection('tasks').doc(id).get()
            .then(doc => {
              if (doc.exists) {
                showEditTaskModal(id, doc.data());
              }
            })
            .catch(error => {
              console.error("Error fetching task:", error);
            });
        });

        taskItem.querySelector('.delete-task').addEventListener('click', function() {
          if (confirm('האם אתה בטוח שברצונך למחוק משימה זו?')) {
            deleteTask(id);
          }
        });

        return taskItem;
      }

      function updateTaskStatus(taskId, completed) {
        showLoader();

        db.collection('tasks').doc(taskId).update({
          completed: completed,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          hideLoader();
          // עדכון ויזואלי של המשימה
          const taskElement = document.querySelector(`.task-checkbox[data-id="${taskId}"]`).closest('.task-item');
          if (completed) {
            taskElement.classList.add('completed');
          } else {
            taskElement.classList.remove('completed');
          }
        })
        .catch(error => {
          hideLoader();
          console.error("Error updating task status:", error);
          alert('שגיאה בעדכון סטטוס המשימה');
        });
      }

      function showAddTaskModal(isHelpRequest = false) {
        document.getElementById('task-modal-title').textContent = isHelpRequest ? 'בקשת עזרה חדשה' : 'משימה חדשה';
        document.getElementById('task-name').value = '';
        document.getElementById('task-description').value = '';
        document.getElementById('task-deadline').value = '';
        document.getElementById('task-id').value = '';
        document.getElementById('task-project-id').value = currentProjectId;
        document.getElementById('task-tags-hidden').value = '[]';

        // איפוס תגיות
        document.getElementById('task-tags-items').innerHTML = '';
        document.getElementById('task-tag-input').value = '';

        // מילוי תאריך היעד של הפרויקט כברירת מחדל אם קיים
        if (currentProjectData && currentProjectData.deadline) {
          document.getElementById('task-deadline').value = currentProjectData.deadline;
        }

        // הצגת בחירת אחראי רק בפרויקטים צוותיים
        const assigneeSection = document.getElementById('task-assignee-section');
        const assigneeSelect = document.getElementById('task-assignee');

        if (currentProjectData && currentProjectData.type === 'team') {
          // מילוי רשימת חברי הצוות
          assigneeSelect.innerHTML = '<option value="">לא משויך</option>';

          currentProjectMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.userId;
            option.textContent = member.displayName;
            assigneeSelect.appendChild(option);
          });

          assigneeSection.style.display = 'block';
        } else {
          assigneeSection.style.display = 'none';
        }

        // חלק בקשת העזרה
        document.getElementById('task-help-section').style.display = currentProjectData && currentProjectData.type === 'team' ? 'block' : 'none';
        document.getElementById('task-help-request').checked = isHelpRequest;

        document.getElementById('task-modal').style.display = 'block';
      }

      function showEditTaskModal(taskId, task) {
        document.getElementById('task-modal-title').textContent = task.isHelpRequest ? 'עריכת בקשת עזרה' : 'עריכת משימה';
        document.getElementById('task-name').value = task.name || '';
        document.getElementById('task-description').value = task.description || '';
        document.getElementById('task-deadline').value = task.deadline || '';
        document.getElementById('task-id').value = taskId;
        document.getElementById('task-project-id').value = task.projectId;

        // טעינת תגיות
        loadTagsToInput(task.tags || []);

        // הצגת בחירת אחראי רק בפרויקטים צוותיים
        const assigneeSection = document.getElementById('task-assignee-section');
        const assigneeSelect = document.getElementById('task-assignee');

        if (currentProjectData && currentProjectData.type === 'team') {
          // מילוי רשימת חברי הצוות
          assigneeSelect.innerHTML = '<option value="">לא משויך</option>';

          currentProjectMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.userId;
            option.textContent = member.displayName;

            // בחירת האחראי הנוכחי
            if (task.assigneeId && task.assigneeId === member.userId) {
              option.selected = true;
            }

            assigneeSelect.appendChild(option);
          });

          assigneeSection.style.display = 'block';
        } else {
          assigneeSection.style.display = 'none';
        }

        // חלק בקשת העזרה
        document.getElementById('task-help-section').style.display = currentProjectData && currentProjectData.type === 'team' ? 'block' : 'none';
        document.getElementById('task-help-request').checked = task.isHelpRequest || false;

        document.getElementById('task-modal').style.display = 'block';
      }

      function saveTask() {
        const name = document.getElementById('task-name').value.trim();
        const description = document.getElementById('task-description').value.trim();
        const deadline = document.getElementById('task-deadline').value;
        const taskId = document.getElementById('task-id').value;
        const projectId = document.getElementById('task-project-id').value;
        const tagsJson = document.getElementById('task-tags-hidden').value;
        const tags = tagsJson ? JSON.parse(tagsJson) : [];

        // מידע על בקשת העזרה
        const isHelpRequest = document.getElementById('task-help-request').checked;

        // מידע על האחראי (רק בפרויקטים צוותיים)
        let assigneeId = null;
        if (currentProjectData && currentProjectData.type === 'team') {
          assigneeId = document.getElementById('task-assignee').value;

          // אם זו בקשת עזרה ללא אחראי, לאפס את האחראי
          if (isHelpRequest && !assigneeId) {
            assigneeId = null;
          }
        }

        if (!name) {
          alert('אנא הזן שם למשימה');
          return;
        }

        if (!projectId) {
          alert('שגיאה: לא נבחר פרויקט');
          return;
        }

        showLoader();

        const taskData = {
          name,
          description,
          deadline,
          projectId,
          tags,
          isHelpRequest,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // הוספת שדה האחראי רק בפרויקט צוותי
        if (currentProjectData && currentProjectData.type === 'team') {
          taskData.assigneeId = assigneeId || null;
        }

        let savePromise;

        if (taskId) {
          // עדכון משימה קיימת
          savePromise = db.collection('tasks').doc(taskId).update(taskData);
        } else {
          // יצירת משימה חדשה
          taskData.completed = false;
          taskData.createdBy = currentUser.uid;
          taskData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          savePromise = db.collection('tasks').add(taskData);
        }

        savePromise
          .then(() => {
            hideLoader();
            document.getElementById('task-modal').style.display = 'none';

            // עדכון הסינון לפי תגיות
            updateProjectTaskTagsDropdown(projectId);

            // טעינה מחדש של המשימות
            loadTasks(projectId);
          })
          .catch(error => {
            hideLoader();
            console.error("Error saving task:", error);
            alert('שגיאה בשמירת משימה');
          });
      }

      function deleteTask(taskId) {
        showLoader();

        db.collection('tasks').doc(taskId).delete()
          .then(() => {
            hideLoader();
            loadTasks(currentProjectId);
          })
          .catch(error => {
            hideLoader();
            console.error("Error deleting task:", error);
            alert('שגיאה במחיקת משימה');
          });
      }

      // סגירת מודלים בלחיצה מחוץ לתוכן
      window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      // הוספת כונני אבחון לזיהוי בעיות
      console.log("Debugging mode enabled");

      // מעקב אחר שגיאות
      window.addEventListener('error', function(e) {
        console.error("Global error:", e.message, e);
      });
    </script>
  </body>
  </html>
