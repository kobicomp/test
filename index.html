<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>מערכת הזמנת חדר דינאמיקלאס</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --empty-cell: #e8f5e9;
            --booked-cell: #ffebee;
            --pending-cell: #fff3e0;
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .room-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .room-info h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .room-info p {
            margin: 10px 0 0 0;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .cell-empty {
            background-color: var(--empty-cell);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .cell-empty:hover {
            background-color: #d0e8d1;
        }

        .cell-booked {
            background-color: var(--booked-cell);
            transition: background-color 0.3s ease;
        }

        .cell-pending {
            background-color: var(--pending-cell);
            transition: background-color 0.3s ease;
        }

        .booking-info {
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .booking-info.pending {
            border: 2px dashed var(--warning-color);
        }

        .status-text {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-text.available {
            color: var(--success-color);
        }

        .status-text.booked {
            color: var(--danger-color);
        }

        .status-text.pending {
            color: var(--warning-color);
        }

        .booking-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: var(--primary-color);
            color: white;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: var(--danger-color);
            margin-top: 5px;
            font-size: 0.9em;
            padding: 5px;
            border-radius: 4px;
        }

        .info {
            color: var(--primary-color);
            margin-top: 5px;
            font-size: 0.9em;
            padding: 5px;
            border-radius: 4px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1002;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.success {
            border-right: 4px solid var(--success-color);
        }

        .notification.error {
            border-right: 4px solid var(--danger-color);
        }

        .notification.warning {
            border-right: 4px solid var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="room-info">
            <h2>חדר דינאמיקלאס</h2>
            <p>חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית</p>
            <p>מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים</p>
        </div>

        <div class="controls">
            <div class="week-nav">
                <button onclick="scheduler.changeWeek(-1)" aria-label="שבוע קודם">◀ שבוע קודם</button>
                <span id="current-week"></span>
                <button onclick="scheduler.changeWeek(1)" aria-label="שבוע הבא">שבוע הבא ▶</button>
            </div>
        </div>

        <table id="schedule">
            <thead>
                <tr>
                    <th>שעה</th>
                    <th>ראשון</th>
                    <th>שני</th>
                    <th>שלישי</th>
                    <th>רביעי</th>
                    <th>חמישי</th>
                    <th>שישי</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="booking-form" id="booking-form">
        <h3>הזמנת חדר</h3>
        <form id="reservation-form">
            <div class="form-group">
                <label for="teacher">שם המורה:</label>
                <select id="teacher" required></select>
                <div id="teacher-status" class="info"></div>
            </div>
            <div class="form-group">
                <label for="class">כיתה:</label>
                <select id="class" required></select>
                <div id="class-status" class="info"></div>
            </div>
            <div class="form-group">
                <label for="subject">מקצוע:</label>
                <input type="text" id="subject" required>
            </div>
            <input type="hidden" id="selected-date">
            <input type="hidden" id="selected-hour">
            <div id="error-message" class="error"></div>
            <div id="status-message" class="info"></div>
            <button type="submit" class="submit-btn">שמור</button>
            <button type="button" class="cancel-btn" onclick="scheduler.closeForm()">ביטול</button>
        </form>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">טוען נתונים...</div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // הגדרת מצבי סטטוס אפשריים
        const BookingStatus = {
            PENDING: 'pending',
            APPROVED: 'approved',
            REJECTED: 'rejected'
        };

        const ROOM_NAME = "חדר דינאמיקלאס";
        const CONFIG = {
            systemName: "חדר דינאמיקלאס",
            systemDescription: "חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית",
            systemDetails: "מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים",

            daysSchedule: {
                0: { name: 'ראשון', lessons: 7 },
                1: { name: 'שני', lessons: 7 },
                2: { name: 'שלישי', lessons: 5 },
                3: { name: 'רביעי', lessons: 7 },
                4: { name: 'חמישי', lessons: 7 },
                5: { name: 'שישי', lessons: 4 }
            },

            urls: {
                schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR5uPK7t_NLTPGlZR4sU0owKAwoygzxa_924tiZH3dHDEEl-f72zjw1ra1AxObkbpMpLURv61Rv4a8M/pub?output=csv',
                teachers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvRHe90lOs14oPNfL3uRqN73uEgmg7L_ON2gXnCD-CuZ_FmTZDRb-rxmmZmeq4frFxh-IMcGLEfy-/pub?output=csv',
                classes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1t6xbHD1i8uWUFQb5MmaHbjjyOLhcCdxs26f0nIABkNoGULEia-mfdsS78KlLNeZdtJ31XQEdi70C/pub?gid=0&single=true&output=csv',
                form: 'https://docs.google.com/forms/d/e/1FAIpQLSeOFAZPcacD0pPV6ffQW4Eg5FpMvLqyTHjz3RZ1i5KMJeGrkQ/formResponse'
            },

            formFields: {
                teacher: "entry.1323321977",
                class: "entry.1450687623",
                date: "entry.1431651377",
                hour: "entry.1887686014",
                subject: "entry.1869424962",
                roomName: "entry.2087001113"
            },

            maxWeeklyBookings: 4,
            maxWeeksAhead: 4,
            statusCheckInterval: 5,        // בדיקה כל 5 שניות
            maxStatusCheckAttempts: 12,    // מקסימום 12 ניסיונות (דקה)
            autoRefreshInterval: 60,       // רענון אוטומטי כל 60 שניות
            notificationDuration: 5000     // משך זמן להצגת התראות (5 שניות)
            };
            const scheduler = {
    currentWeek: moment(),
    scheduleData: [],
    teachersList: [],
    classesList: [],
    activeStatusChecks: new Map(),

    // פונקציית עזר להצגת התראות
    showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, CONFIG.notificationDuration);
    },

    // מנהל ההזמנות הזמניות
    tempBookingsManager: {
        STORAGE_KEY: 'tempBookings_dynamiclass',

        getData() {
            try {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch {
                return {};
            }
        },

        setData(bookings) {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(bookings));
        },

        addBooking(booking) {
            const bookings = this.getData();
            const key = `${booking.תאריך}_${booking['שעה במערכת']}`;
            bookings[key] = {
                ...booking,
                timestamp: Date.now()
            };
            this.setData(bookings);
            return key;
        },

        removeBooking(key) {
            const bookings = this.getData();
            if (bookings[key]) {
                delete bookings[key];
                this.setData(bookings);
            }
        },

        getValidBookings() {
            return this.getData();
        }
    },

    async loadData(isInitial = false) {
        this.showLoading();
        try {
            if (isInitial) {
                await Promise.all([
                    this.loadTeachers(),
                    this.loadClasses()
                ]);
            }
            await this.loadSchedule();
            await this.delay(500);
        } catch (error) {
            console.error('Error loading data:', error);
            this.showNotification('אירעה שגיאה בטעינת הנתונים', 'error');
        } finally {
            this.hideLoading();
        }
    },

    async loadSchedule() {
        try {
            const timestamp = Date.now();
            const response = await fetch(`${CONFIG.urls.schedule}?t=${timestamp}`, {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const csvText = await response.text();
            const newScheduleData = this.parseCSV(csvText);

            // בדיקת הזמנות זמניות
            const tempBookings = this.tempBookingsManager.getValidBookings();
            for (const [key, tempBooking] of Object.entries(tempBookings)) {
                const confirmedBooking = newScheduleData.find(booking =>
                    booking.תאריך === tempBooking.תאריך &&
                    booking['שעה במערכת'] === tempBooking['שעה במערכת']
                );

                if (confirmedBooking) {
                    const isOurBooking = confirmedBooking['שם המורה'] === tempBooking['שם המורה'] &&
                                       confirmedBooking['כיתה'] === tempBooking['כיתה'];

                    this.tempBookingsManager.removeBooking(key);
                    
                    if (this.activeStatusChecks.has(key)) {
                        clearInterval(this.activeStatusChecks.get(key));
                        this.activeStatusChecks.delete(key);

                        if (isOurBooking) {
                            this.showNotification('ההזמנה אושרה בהצלחה!', 'success');
                        } else {
                            this.showNotification(
                                `המורה ${confirmedBooking['שם המורה']} כבר הזמין/ה את החדר לשעה זו`,
                                'error'
                            );
                        }
                    }
                }
            }

            this.scheduleData = newScheduleData.filter(entry => 
                entry['שם החדר'] === ROOM_NAME
            );
            this.renderSchedule();
        } catch (error) {
            console.error('Error loading schedule:', error);
            throw error;
        }
    },

    async loadTeachers() {
        const response = await fetch(CONFIG.urls.teachers);
        const csvText = await response.text();
        this.teachersList = this.parseList(csvText);
        this.populateSelect('teacher', this.teachersList);
    },

    async loadClasses() {
        const response = await fetch(CONFIG.urls.classes);
        const csvText = await response.text();
        this.classesList = this.parseList(csvText);
        this.populateSelect('class', this.classesList);
    },

    populateSelect(id, items) {
        const select = document.getElementById(id);
        select.innerHTML = `<option value="">בחר/י ${id === 'teacher' ? 'מורה' : 'כיתה'}</option>`;
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });
    },

    async startStatusCheck(booking) {
        const key = `${booking.תאריך}_${booking['שעה במערכת']}`;
        let attempts = 0;

        if (this.activeStatusChecks.has(key)) {
            clearInterval(this.activeStatusChecks.get(key));
        }

        const checkInterval = setInterval(async () => {
            attempts++;
            
            try {
                const timestamp = Date.now();
                const response = await fetch(`${CONFIG.urls.schedule}?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const bookings = this.parseCSV(csvText);

                const confirmedBooking = bookings.find(b =>
                    b.תאריך === booking.תאריך &&
                    b['שעה במערכת'] === booking['שעה במערכת']
                );

                if (confirmedBooking) {
                    const isOurBooking = confirmedBooking['שם המורה'] === booking['שם המורה'] &&
                                       confirmedBooking['כיתה'] === booking['כיתה'];

                    clearInterval(checkInterval);
                    this.activeStatusChecks.delete(key);
                    this.tempBookingsManager.removeBooking(key);

                    if (isOurBooking) {
                        this.showNotification('ההזמנה אושרה בהצלחה!', 'success');
                    } else {
                        this.showNotification(
                            `המורה ${confirmedBooking['שם המורה']} כבר הזמין/ה את החדר לשעה זו`,
                            'error'
                        );
                    }

                    this.scheduleData = bookings.filter(entry => 
                        entry['שם החדר'] === ROOM_NAME
                    );
                    this.renderSchedule();
                    return;
                }

                if (attempts >= CONFIG.maxStatusCheckAttempts) {
                    this.showNotification('ההזמנה עדיין בהמתנה לאישור. נא לבדוק שוב מאוחר יותר.', 'warning');
                    clearInterval(checkInterval);
                    this.activeStatusChecks.delete(key);
                    this.tempBookingsManager.removeBooking(key);
                    this.renderSchedule();
                    return;
                }

            } catch (error) {
                console.error('Error checking booking status:', error);
            }
        }, CONFIG.statusCheckInterval * 1000);

        this.activeStatusChecks.set(key, checkInterval);
    },

    async handleSubmit(event) {
        event.preventDefault();
        const submitButton = event.target.querySelector('.submit-btn');
        submitButton.disabled = true;

        try {
            const formData = {
                'שם המורה': document.getElementById('teacher').value,
                'כיתה': document.getElementById('class').value,
                'תאריך': document.getElementById('selected-date').value,
                'שעה במערכת': document.getElementById('selected-hour').value,
                'מקצוע': document.getElementById('subject').value,
                'שם החדר': ROOM_NAME
            };

            // וידוא שכל השדות מלאים
            for (const [key, value] of Object.entries(formData)) {
                if (!value) {
                    throw new Error(`נא למלא את השדה ${key}`);
                }
            }

            // בדיקה אחרונה לפני שמירה
            const key = `${formData.תאריך}_${formData['שעה במערכת']}`;
            if (this.getBookingForSlot(formData.תאריך, parseInt(formData['שעה במערכת']))) {
                throw new Error('החדר כבר תפוס בשעה זו');
            }

            // שמירה זמנית
            this.tempBookingsManager.addBooking(formData);

            // עדכון תצוגה מיידית
            this.renderSchedule();

            // הכנת הנתונים לטופס Google
            const googleFormData = new FormData();
            for (const [field, entryId] of Object.entries(CONFIG.formFields)) {
                googleFormData.append(entryId, formData[field] || '');
            }

            // שליחה לטופס Google
            await fetch(CONFIG.urls.form, {
                method: 'POST',
                body: googleFormData,
                mode: 'no-cors'
            });

            // התחלת בדיקת סטטוס
            this.startStatusCheck(formData);

            this.closeForm();
            this.showNotification('ההזמנה נשלחה ונמצאת בבדיקה', 'info');

        } catch (error) {
            console.error('Error in handleSubmit:', error);
            document.getElementById('error-message').textContent = error.message;
            this.showNotification(error.message, 'error');
        } finally {
            submitButton.disabled = false;
        }
    },

    getBookingForSlot(date, hour) {
        // בדיקת הזמנות קבועות
        const permanentBooking = this.scheduleData.find(booking =>
            booking.תאריך === date &&
            parseInt(booking['שעה במערכת']) === hour
        );
        if (permanentBooking) return permanentBooking;

        // בדיקת הזמנות זמניות
        const tempBookings = this.tempBookingsManager.getValidBookings();
        const key = `${date}_${hour}`;
        const tempBooking = tempBookings[key];

        if (tempBooking) {
            return { ...tempBooking, isPending: true };
        }

        return null;
    },

    renderSchedule() {
            const tbody = document.querySelector('#schedule tbody');
            tbody.innerHTML = '';
    
            const startOfWeek = this.currentWeek.clone().startOf('week');
            document.getElementById('current-week').textContent =
                `${startOfWeek.format('DD/MM/YYYY')} - ${startOfWeek.clone().endOf('week').format('DD/MM/YYYY')}`;
    
            for (let hour = 1; hour <= Math.max(...Object.values(CONFIG.daysSchedule).map(d => d.lessons)); hour++) {
                const row = document.createElement('tr');
    
                // תא שעה
                const hourCell = document.createElement('td');
                hourCell.textContent = `שעה ${hour}`;
                hourCell.style.fontWeight = 'bold';
                row.appendChild(hourCell);
    
                // תאים לכל יום
                for (let day = 0; day < 6; day++) {
                    if (hour <= CONFIG.daysSchedule[day].lessons) {
                        const cell = document.createElement('td');
                        const date = startOfWeek.clone().add(day, 'days').format('YYYY-MM-DD');
                        const booking = this.getBookingForSlot(date, hour);
    
                        if (booking) {
                            cell.className = booking.isPending ? 'cell-pending' : 'cell-booked';
                            cell.innerHTML = `
                                <div class="booking-info ${booking.isPending ? 'pending' : ''}">
                                    <div class="status-text ${booking.isPending ? 'pending' : 'booked'}">
                                        ${booking.isPending ? 'ממתין לאישור' : 'תפוס'}
                                    </div>
                                    <strong>${booking['שם המורה']}</strong><br>
                                    כיתה: ${booking['כיתה']}<br>
                                    ${booking['מקצוע']}
                                </div>
                            `;
                        } else {
                            // בדיקה האם התאריך עבר
                            const cellDate = moment(date);
                            const today = moment().startOf('day');
                            
                            if (cellDate.isBefore(today)) {
                                cell.className = 'cell-past';
                                cell.innerHTML = '<div class="status-text past">עבר</div>';
                            } else {
                                cell.className = 'cell-empty';
                                cell.innerHTML = '<div class="status-text available">פנוי</div>';
                                cell.onclick = () => this.openBookingForm(date, hour);
                            }
                        }
    
                        row.appendChild(cell);
                    } else {
                        const emptyCell = document.createElement('td');
                        emptyCell.style.backgroundColor = '#eee';
                        row.appendChild(emptyCell);
                    }
                }
                tbody.appendChild(row);
            }
        },
    
        openBookingForm(date, hour) {
            // בדיקה האם התאריך עבר
            if (moment(date).isBefore(moment().startOf('day'))) {
                this.showNotification('לא ניתן להזמין תאריך שעבר', 'error');
                return;
            }
    
            // בדיקה האם התאריך רחוק מדי
            const maxDate = moment().add(CONFIG.maxWeeksAhead, 'weeks').endOf('week');
            if (moment(date).isAfter(maxDate)) {
                this.showNotification(`לא ניתן להזמין יותר מ-${CONFIG.maxWeeksAhead} שבועות מראש`, 'error');
                return;
            }
    
            document.getElementById('selected-date').value = date;
            document.getElementById('selected-hour').value = hour;
            document.getElementById('error-message').textContent = '';
            document.getElementById('status-message').textContent = '';
            document.getElementById('reservation-form').reset();
    
            this.updateWeeklyStatus(date);
    
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('booking-form').style.display = 'block';
        },
    
        closeForm() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('booking-form').style.display = 'none';
            document.getElementById('error-message').textContent = '';
            document.getElementById('status-message').textContent = '';
        },
    
        updateWeeklyStatus(date) {
            const weekStart = moment(date).startOf('week');
            const teacher = document.getElementById('teacher').value;
            const className = document.getElementById('class').value;
    
            if (teacher) {
                const teacherBookings = this.countWeeklyBookings('שם המורה', teacher, weekStart);
                document.getElementById('teacher-status').textContent =
                    `שיעורים השבוע: ${teacherBookings}/${CONFIG.maxWeeklyBookings}`;
            }
    
            if (className) {
                const classBookings = this.countWeeklyBookings('כיתה', className, weekStart);
                document.getElementById('class-status').textContent =
                    `שיעורים השבוע: ${classBookings}/${CONFIG.maxWeeklyBookings}`;
            }
        },
    
        countWeeklyBookings(field, value, weekStart) {
            const weekEnd = weekStart.clone().endOf('week');
            let count = 0;
    
            // ספירת הזמנות קבועות
            count += this.scheduleData.filter(booking => {
                const bookingDate = moment(booking['תאריך']);
                return booking[field] === value &&
                       bookingDate.isBetween(weekStart, weekEnd, 'day', '[]');
            }).length;
    
            // ספירת הזמנות זמניות
            const tempBookings = this.tempBookingsManager.getValidBookings();
            count += Object.values(tempBookings).filter(booking => {
                const bookingDate = moment(booking['תאריך']);
                return booking[field] === value &&
                       bookingDate.isBetween(weekStart, weekEnd, 'day', '[]');
            }).length;
    
            return count;
        },
    
        changeWeek(delta) {
            const newWeek = this.currentWeek.clone().add(delta, 'weeks');
            const today = moment();
            const maxDate = today.clone().add(CONFIG.maxWeeksAhead, 'weeks').endOf('week');
    
            if (delta > 0 && newWeek.startOf('week').isAfter(maxDate)) {
                this.showNotification(`לא ניתן להזמין יותר מ-${CONFIG.maxWeeksAhead} שבועות מראש`, 'warning');
                return;
            }
    
            if (delta < 0 && newWeek.startOf('week').isBefore(today.startOf('week'))) {
                this.showNotification('לא ניתן להזמין בתאריך שעבר', 'warning');
                return;
            }
    
            this.currentWeek = newWeek;
            this.renderSchedule();
        },
    
        showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        },
    
        hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        },
    
        async delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },
    
        parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1)
                .map(line => {
                    const values = line.split(',').map(v => v.trim());
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header] = values[i];
                    });
                    return entry;
                })
                .filter(entry => entry['שם המורה'] && entry['תאריך']);
        },
    
        parseList(csv) {
            return csv.split('\n')
                .map(line => line.split(',')[0].trim())
                .filter(item => item && item !== 'null' && item !== '');
        }
    };
    
    // אתחול
    document.addEventListener('DOMContentLoaded', () => {
        scheduler.loadData(true);
        setInterval(() => scheduler.loadData(), CONFIG.autoRefreshInterval * 1000);
    
        document.getElementById('teacher').addEventListener('change', () =>
            scheduler.updateWeeklyStatus(document.getElementById('selected-date').value));
    
        document.getElementById('class').addEventListener('change', () =>
            scheduler.updateWeeklyStatus(document.getElementById('selected-date').value));
    
        document.getElementById('reservation-form').addEventListener('submit', (e) =>
            scheduler.handleSubmit(e));
    
        // סגירת הטופס בלחיצה על המסך האפור
        document.getElementById('overlay').addEventListener('click', () => scheduler.closeForm());
    
        // מניעת סגירה בלחיצה על הטופס עצמו
        document.getElementById('booking-form').addEventListener('click', (e) => e.stopPropagation());
    });
    </script>
    </body>
    </html>
