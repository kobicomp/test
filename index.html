<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת הזמנות</title>
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --warning-color: #fbbc05;
            --error-color: #ea4335;
            --light-gray: #f8f9fa;
            --border-color: #dadce0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            direction: rtl;
        }

        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="tel"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin-right: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #1669d9;
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #f1f3f4;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #e6f4ea;
            color: var(--secondary-color);
            border: 1px solid #ceead6;
        }

        .error {
            background-color: #fce8e6;
            color: var(--error-color);
            border: 1px solid #fdded9;
        }

        .info {
            background-color: #e8f0fe;
            color: var(--primary-color);
            border: 1px solid #d2e3fc;
        }

        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stats-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .countdown {
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>מערכת הזמנות</h1>

        <div class="stats" id="stats">
            <h2>סטטוס הזמנות</h2>
            <div class="stats-item">
                <span>מספר המקומות הכולל:</span>
                <span class="stats-value" id="total-slots">20</span>
            </div>
            <div class="stats-item">
                <span>מקומות שהוזמנו:</span>
                <span class="stats-value" id="reserved-slots">0</span>
            </div>
            <div class="stats-item">
                <span>מקומות פנויים:</span>
                <span class="stats-value" id="available-slots">20</span>
            </div>
            <div class="stats-item">
                <span>עדכון אחרון:</span>
                <span id="last-update">טוען...</span>
            </div>
            <div>
                <button id="refresh-btn" class="btn btn-secondary">רענן נתונים</button>
                <span id="countdown" class="countdown"></span>
            </div>
        </div>

        <div id="reservation-form">
            <h2>טופס הזמנה</h2>
            <div class="form-group">
                <label for="firstName">שם פרטי:</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">שם משפחה:</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="phone">מספר טלפון:</label>
                <input type="tel" id="phone" name="phone" required>
            </div>
            
            <button id="reserve-btn" class="btn">שלח הזמנה</button>
        </div>

        <div class="loader" id="loader">
            <div class="loader-spinner"></div>
            <p>מבצע פעולה...</p>
        </div>

        <div class="status success" id="success-message"></div>
        <div class="status error" id="error-message"></div>
        <div class="status info" id="info-message"></div>
    </div>

    <script>
        // הגדרות המערכת
        const CONFIG = {
            // הגדרת מספר המקומות הכולל
            TOTAL_SLOTS: 20,
            
            // כתובת גליון הנתונים כ-JSONP
            // שימוש ב-sheetdb.io כשירות ביניים לגישה לגיליון
            SPREADSHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZuqwnqomuxxsB2lIcXp4VHBQqwzEoHJ9t99Kb057hIr8GQEOnbmw9NxLkztaER59W572o3kVymiyx/pubhtml',
            
            // כתובת הטופס - לשימוש בהגשת הטופס
            FORM_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSfMRzTBNEKqeg_ubQwhPNr9u78h5a3ynPdsq7q77azwKF9S9g/formResponse',
            
            // שדות הטופס
            FORM_FIELDS: {
                firstName: "entry.1726269772",
                lastName: "entry.1766470893",
                phone: "entry.2028941780",
                status: "entry.1406108683"
            },
            
            // זמן רענון אוטומטי (בשניות)
            AUTO_REFRESH_TIME: 60,
            
            // שם הסוכן המשתמש לצורך הבקשה לשרת
            USER_AGENT: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            
            // CORS Proxy - לעקיפת מגבלות CORS
            CORS_PROXY: 'https://cors-anywhere.herokuapp.com/'
        };

        // מצב המערכת
        const state = {
            reservedSlots: 0,
            availableSlots: CONFIG.TOTAL_SLOTS,
            lastUpdate: null,
            isLoading: false,
            refreshTimer: null,
            countdownValue: CONFIG.AUTO_REFRESH_TIME,
            fallbackMode: false  // מצב גיבוי למקרה של בעיות בגישה לנתונים
        };

        // אלמנטים בדף
        const elements = {
            totalSlots: document.getElementById('total-slots'),
            reservedSlots: document.getElementById('reserved-slots'),
            availableSlots: document.getElementById('available-slots'),
            lastUpdate: document.getElementById('last-update'),
            refreshBtn: document.getElementById('refresh-btn'),
            reserveBtn: document.getElementById('reserve-btn'),
            loader: document.getElementById('loader'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            infoMessage: document.getElementById('info-message'),
            countdown: document.getElementById('countdown'),
            firstName: document.getElementById('firstName'),
            lastName: document.getElementById('lastName'),
            phone: document.getElementById('phone')
        };

        // אתחול המערכת
        function init() {
            // עדכון הנתונים הראשוני
            updateStats();
            
            // הגדרת אירועים
            elements.refreshBtn.addEventListener('click', updateStats);
            elements.reserveBtn.addEventListener('click', submitReservation);
            
            // התחלת טיימר רענון אוטומטי
            startAutoRefresh();
            
            // עדכון מספר המקומות הכולל
            elements.totalSlots.textContent = CONFIG.TOTAL_SLOTS;
        }

        // פונקציה לעדכון הנתונים מגוגל שיטס
        async function updateStats() {
            if (state.isLoading) return;
            
            showLoader(true);
            state.isLoading = true;
            
            try {
                // שימוש בשיטה 1: ניסיון לקרוא באמצעות Google Sheets API
                await fetchStatsMethod1();
            } catch (error) {
                console.warn('Method 1 failed, trying method 2', error);
                
                try {
                    // שיטה 2: שימוש בגישה ישירה לקובץ CSV
                    await fetchStatsMethod2();
                } catch (error2) {
                    console.warn('Method 2 failed, trying method 3', error2);
                    
                    try {
                        // שיטה 3: שימוש ב-CORS Proxy
                        await fetchStatsMethod3();
                    } catch (error3) {
                        console.error('All methods failed:', error3);
                        
                        // מעבר למצב גיבוי - שימוש בנתונים מקומיים
                        if (!state.fallbackMode) {
                            state.fallbackMode = true;
                            showMessage('warning', 'לא ניתן להתחבר לשרת הנתונים. המערכת פועלת במצב מקומי.');
                        }
                        
                        // שימוש בנתונים מקומיים (localStorage)
                        useLocalFallback();
                    }
                }
            } finally {
                showLoader(false);
                state.isLoading = false;
                resetCountdown();
            }
        }

        // שיטה 1: ניסיון גישה דרך Sheetdb.io (שירות שמאפשר גישה לגיליונות Google כ-API)
        async function fetchStatsMethod1() {
            // שים לב: דורש רישום בשירות sheetdb.io והקמת קישור לגיליון שלך
            const url = CONFIG.SPREADSHEET_URL;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch data from SheetDB');
            }
            
            const data = await response.json();
            updateStatsFromData(data.length);
        }

        // שיטה 2: ניסיון גישה ישירה לקובץ CSV
        async function fetchStatsMethod2() {
            // כתובת ישירה של גיליון ה-CSV - צריך להחליף עם הכתובת האמיתית
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZuqwnqomuxxsB2lIcXp4VHBQqwzEoHJ9t99Kb057hIr8GQEOnbmw9NxLkztaER59W572o3kVymiyx/pub?output=csv';
            
            const response = await fetch(url + '&cachebust=' + new Date().getTime(), {
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                },
                cache: 'no-store'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch CSV');
            }
            
            const csvText = await response.text();
            const rows = csvText.trim().split('\n').filter(row => row.trim());
            
            // שורה ראשונה היא כותרות - לא סופרים אותה
            const count = Math.max(0, rows.length - 1);
            updateStatsFromData(count);
        }

        // שיטה 3: שימוש ב-CORS Proxy
        async function fetchStatsMethod3() {
            // שימוש ב-CORS Proxy לעקיפת הגבלות אבטחה
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZuqwnqomuxxsB2lIcXp4VHBQqwzEoHJ9t99Kb057hIr8GQEOnbmw9NxLkztaER59W572o3kVymiyx/pub?output=csv';
            const proxyUrl = CONFIG.CORS_PROXY + csvUrl;
            
            const response = await fetch(proxyUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'User-Agent': CONFIG.USER_AGENT,
                    'Origin': window.location.origin
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch via proxy');
            }
            
            const csvText = await response.text();
            const rows = csvText.trim().split('\n').filter(row => row.trim());
            
            // שורה ראשונה היא כותרות - לא סופרים אותה
            const count = Math.max(0, rows.length - 1);
            updateStatsFromData(count);
        }

        // שימוש בנתונים מקומיים כאשר אין גישה לשרת
        function useLocalFallback() {
            // בדיקה אם יש כבר נתונים ב-localStorage
            const localCount = localStorage.getItem('reservationCount');
            const count = localCount ? parseInt(localCount) : 0;
            
            updateStatsFromData(count);
        }

        // עדכון הנתונים ממספר ההזמנות
        function updateStatsFromData(count) {
            state.reservedSlots = count;
            state.availableSlots = Math.max(0, CONFIG.TOTAL_SLOTS - count);
            state.lastUpdate = new Date();
            
            // עדכון התצוגה
            elements.reservedSlots.textContent = state.reservedSlots;
            elements.availableSlots.textContent = state.availableSlots;
            elements.lastUpdate.textContent = state.lastUpdate.toLocaleTimeString();
            
            // בדיקה אם נגמרו המקומות
            if (state.availableSlots <= 0) {
                showMessage('info', 'כל המקומות תפוסים כרגע');
                elements.reserveBtn.disabled = true;
            } else {
                elements.reserveBtn.disabled = false;
            }
        }

        // פונקציה לשליחת הזמנה
        async function submitReservation(e) {
            e.preventDefault();
            
            // בדיקות תקינות
            const firstName = elements.firstName.value.trim();
            const lastName = elements.lastName.value.trim();
            const phone = elements.phone.value.trim();
            
            if (!firstName || !lastName || !phone) {
                showMessage('error', 'נא למלא את כל השדות הנדרשים');
                return;
            }
            
            if (phone.length < 9 || !/^\d+$/.test(phone)) {
                showMessage('error', 'מספר טלפון לא תקין');
                return;
            }
            
            // בדיקה אם יש מקומות פנויים
            if (state.availableSlots <= 0) {
                showMessage('error', 'מצטערים, כל המקומות תפוסים כרגע');
                return;
            }
            
            showLoader(true);
            
            try {
                // בדיקה עדכנית של מספר ההזמנות לפני שליחה
                await updateStats();
                
                if (state.availableSlots <= 0) {
                    showMessage('error', 'מצטערים, כל המקומות תפוסים כרגע');
                    return;
                }
                
                // שליחת הנתונים לטופס
                const formData = new FormData();
                formData.append(CONFIG.FORM_FIELDS.firstName, firstName);
                formData.append(CONFIG.FORM_FIELDS.lastName, lastName);
                formData.append(CONFIG.FORM_FIELDS.phone, phone);
                formData.append(CONFIG.FORM_FIELDS.status, "הוזמן");
                
                // שליחה באמצעות iframe מוסתר
                submitFormWithIframe(formData);
                
            } catch (error) {
                console.error('Error submitting reservation:', error);
                showMessage('error', 'שגיאה בשליחת ההזמנה, נסו שוב מאוחר יותר');
                showLoader(false);
            }
        }

        // פונקציה לשליחת הטופס באמצעות iframe (עוקפת CORS)
        function submitFormWithIframe(formData) {
            // יצירת טופס זמני
            const form = document.createElement('form');
            form.action = CONFIG.FORM_URL;
            form.method = 'POST';
            form.target = 'submission-frame';
            form.style.display = 'none';
            
            // הוספת השדות לטופס
            for (const [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            // יצירת iframe להגשה
            const iframe = document.createElement('iframe');
            iframe.name = 'submission-frame';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // טיפול באירועי הגשה
            iframe.addEventListener('load', function() {
                // עדכון התצוגה
                elements.firstName.value = '';
                elements.lastName.value = '';
                elements.phone.value = '';
                
                // אם אנחנו במצב גיבוי, נעדכן את המונה המקומי
                if (state.fallbackMode) {
                    const localCount = localStorage.getItem('reservationCount') || '0';
                    localStorage.setItem('reservationCount', (parseInt(localCount) + 1).toString());
                }
                
                showLoader(false);
                showMessage('success', 'ההזמנה נשלחה בהצלחה!');
                
                // עדכון הנתונים מחדש
                setTimeout(updateStats, 1000);
                
                // הסרת הטופס והאייפריים
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);
            });
            
            // הוספת הטופס לעמוד ושליחתו
            document.body.appendChild(form);
            form.submit();
        }

        // פונקציה להצגת הודעות
        function showMessage(type, message) {
            // ניקוי הודעות קודמות
            elements.successMessage.style.display = 'none';
            elements.errorMessage.style.display = 'none';
            elements.infoMessage.style.display = 'none';
            
            // הצגת ההודעה המתאימה
            if (type === 'success') {
                elements.successMessage.textContent = message;
                elements.successMessage.style.display = 'block';
            } else if (type === 'error') {
                elements.errorMessage.textContent = message;
                elements.errorMessage.style.display = 'block';
            } else if (type === 'info') {
                elements.infoMessage.textContent = message;
                elements.infoMessage.style.display = 'block';
            }
            
            // הסתרת ההודעה אחרי 5 שניות
            setTimeout(() => {
                if (type === 'success') elements.successMessage.style.display = 'none';
                if (type === 'error') elements.errorMessage.style.display = 'none';
                if (type === 'info') elements.infoMessage.style.display = 'none';
            }, 5000);
        }

        // פונקציה להצגת מסך טעינה
        function showLoader(show) {
            elements.loader.style.display = show ? 'block' : 'none';
        }

        // פונקציה להתחלת רענון אוטומטי
        function startAutoRefresh() {
            // ניקוי טיימר קודם אם קיים
            if (state.refreshTimer) {
                clearInterval(state.refreshTimer);
            }
            
            resetCountdown();
            
            // הגדרת טיימר חדש
            state.refreshTimer = setInterval(() => {
                state.countdownValue--;
                
                if (state.countdownValue <= 0) {
                    updateStats();
                } else {
                    updateCountdown();
                }
            }, 1000);
        }

        // איפוס הספירה לאחור
        function resetCountdown() {
            state.countdownValue = CONFIG.AUTO_REFRESH_TIME;
            updateCountdown();
        }

        // עדכון תצוגת הספירה לאחור
        function updateCountdown() {
            elements.countdown.textContent = `רענון אוטומטי בעוד ${state.countdownValue} שניות`;
        }

        // אתחול המערכת כשהדף נטען
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
