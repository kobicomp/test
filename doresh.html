<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>מערכת הזמנת אפיית מצות - בית הכנסת דורש טוב התשפ"ה</title>
   <style>
       :root {
           --primary-color: #2196F3;
           --secondary-color: #4b6cb7;
           --success-color: #4CAF50;
           --danger-color: #f44336;
           --warning-color: #ff9800;
           --light-color: #f5f5f5;
           --dark-color: #333;
       }

       * {
           box-sizing: border-box;
           margin: 0;
           padding: 0;
       }

       body {
           font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
           direction: rtl;
           background-color: var(--light-color);
           line-height: 1.6;
       }

       .container {
           max-width: 100%;
           width: 95%;
           margin: 0 auto;
           padding: 15px;
       }

       .header {
           background: linear-gradient(to left, var(--primary-color), var(--secondary-color));
           color: white;
           text-align: center;
           padding: 15px 0;
           margin-bottom: 20px;
           border-radius: 0 0 10px 10px;
       }

       .header h1 {
           font-size: 1.8em;
           margin-bottom: 10px;
       }

       .logo {
           max-width: 100px;
           margin-bottom: 10px;
       }

       .product-card {
           background-color: white;
           border-radius: 10px;
           box-shadow: 0 3px 10px rgba(0,0,0,0.1);
           padding: 20px;
           margin-bottom: 20px;
       }

       .product-title {
           font-size: 1.5em;
           color: var(--dark-color);
           margin-bottom: 15px;
           padding-bottom: 10px;
           border-bottom: 2px solid #eee;
       }

       .product-description {
           color: #666;
           margin-bottom: 15px;
           font-size: 1em;
       }

       .product-stats {
           display: flex;
           flex-wrap: wrap;
           justify-content: space-between;
           margin-bottom: 15px;
       }

       .stat-box {
           flex: 1;
           min-width: 100px;
           text-align: center;
           background-color: #f9f9f9;
           padding: 10px;
           margin: 5px;
           border-radius: 5px;
       }

       .stat-value {
           font-size: 1.3em;
           font-weight: bold;
           color: var(--primary-color);
       }

       .progress-container {
           background-color: #e0e0e0;
           border-radius: 5px;
           height: 10px;
           margin-bottom: 15px;
           overflow: hidden;
       }

       .progress-bar {
           height: 100%;
           background: linear-gradient(to right, var(--success-color), var(--primary-color));
       }

       .booking-btn {
           width: 100%;
           padding: 10px;
           background-color: var(--primary-color);
           color: white;
           border: none;
           border-radius: 5px;
           cursor: pointer;
           font-size: 1em;
       }

       .booking-form {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: white;
           padding: 20px;
           overflow-y: auto;
           z-index: 1000;
       }

       .form-group {
           margin-bottom: 15px;
       }

       .form-group label {
           display: block;
           margin-bottom: 5px;
           font-weight: bold;
       }

       .form-group input {
           width: 100%;
           padding: 10px;
           border: 1px solid #ddd;
           border-radius: 5px;
       }

       .quantity-counter {
           display: flex;
           justify-content: space-between;
           align-items: center;
           margin-bottom: 15px;
       }

       .counter-btn {
           width: 40px;
           height: 40px;
           background-color: var(--primary-color);
           color: white;
           border: none;
           border-radius: 50%;
           cursor: pointer;
           font-size: 1.2em;
       }

       .counter-value {
           font-size: 1.2em;
           font-weight: bold;
       }

       .form-actions {
           display: flex;
           flex-direction: column;
           gap: 10px;
       }

       .submit-btn, .cancel-btn {
           padding: 10px;
           border: none;
           border-radius: 5px;
           cursor: pointer;
       }

       .submit-btn {
           background-color: var(--success-color);
           color: white;
       }

       .cancel-btn {
           background-color: #f1f1f1;
           color: var(--dark-color);
       }

       @media (min-width: 768px) {
           .container {
               width: 80%;
           }

           .header h1 {
               font-size: 2.2em;
           }

           .logo {
               max-width: 150px;
           }

           .booking-form {
               top: 50%;
               left: 50%;
               transform: translate(-50%, -50%);
               width: 500px;
               max-height: 90vh;
               border-radius: 10px;
               box-shadow: 0 4px 20px rgba(0,0,0,0.2);
           }

           .form-actions {
               flex-direction: row;
               justify-content: space-between;
           }

           .submit-btn, .cancel-btn {
               width: 48%;
           }
       }
   </style>
</head>
<body>
   <div class="header">
       <div class="container">
           <img src="logod.jpg" alt="לוגו" class="logo">
           <h1 id="project-title">אפיית מצות - בית הכנסת דורש טוב</h1>
           <p id="project-subtitle">הזמנת מקומות לאפיית מצות לקראת חג הפסח התשפ"ה</p>
       </div>
   </div>

   <div class="container">
       <div class="product-card">
           <h2 class="product-title" id="product-name">אפיית מצות - בית הכנסת דורש טוב</h2>
           <p class="product-description" id="product-description">
               שלום לכולם!
               פרויקט קהילות של עיריית שדרות שמח להזמין את ציבור הגברים בקהילת "דורש טוב" לאפיית מצות מהודרות ביום שני, ט' בניסן בשעה 19:00 ברחבת בית הכנסת "נאות השקמה".
               שימו לב! מס' המקומות מוגבל, כל הקודם זוכה.
               ההשתתפות בעלות מסובסדת בסך 10 ש"ח.
               הרב יניב וועד בית הכנסת
           </p>

           <div class="product-stats">
               <div class="stat-box">
                   <div class="stat-value" id="total-slots">20</div>
                   <div>סך ההזמנות</div>
               </div>
               <div class="stat-box">
                   <div class="stat-value" id="booked-slots">0</div>
                   <div>הזמנות שבוצעו</div>
               </div>
               <div class="stat-box">
                   <div class="stat-value" id="available-slots">20</div>
                   <div>הזמנות פנויות</div>
               </div>
           </div>

           <div class="progress-container">
               <div class="progress-bar" id="booking-progress"></div>
           </div>

           <button class="booking-btn" id="booking-btn">הזמן עכשיו</button>
       </div>
   </div>

   <div class="booking-form" id="booking-form">
       <form id="reservation-form">
           <div class="form-group">
               <label for="firstName">שם פרטי:</label>
               <input type="text" id="firstName" required>
           </div>
           <div class="form-group">
               <label for="lastName">שם משפחה:</label>
               <input type="text" id="lastName" required>
           </div>
           <div class="form-group">
               <label for="phone">מספר טלפון:</label>
               <input type="tel" id="phone" required pattern="[0-9]{10}" title="יש להזין מספר טלפון בן 10 ספרות">
           </div>
           <div class="form-group">
               <label>מספר אנשים:</label>
               <div class="quantity-counter">
                   <button type="button" class="counter-btn" id="decrease-btn">-</button>
                   <span class="counter-value" id="quantity-value">1</span>
                   <button type="button" class="counter-btn" id="increase-btn">+</button>
               </div>
               <input type="hidden" id="quantity" value="1">
           </div>

           <div class="form-actions">
               <button type="submit" class="submit-btn">שלח הזמנה</button>
               <button type="button" class="cancel-btn" id="cancel-btn">ביטול</button>
           </div>
       </form>
   </div>

   <script>
       // הגדרות המערכת
       const CONFIG = {
           totalSlots: 20,
           maxSlotsPerBooking: 5,
           pricePerPerson: 10,
           autoRefreshInterval: 60,
           urls: {
               form: 'https://docs.google.com/forms/d/e/1FAIpQLSfMRzTBNEKqeg_ubQwhPNr9u78h5a3ynPdsq7q77azwKF9S9g/formResponse',
               sheet: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZuqwnqomuxxsB2lIcXp4VHBQqwzEoHJ9t99Kb057hIr8GQEOnbmw9NxLkztaER59W572o3kVymiyx/pub?output=csv'
           },
           formFields: {
               firstName: "entry.1726269772",
               lastName: "entry.1766470893",
               phone: "entry.2028941780",
               quantity: "entry.1406108683",
               projectName: "entry.1414374653"
           },
           project: {
               name: "אפיית מצות בבית הכנסת דורש טוב התשפ\"ה",
               title: "אפיית מצות - בית הכנסת דורש טוב"
           }
       };

       // מערכת הזמנה
       const bookingSystem = {
           bookingsData: [],
           totalBooked: 0,
           
           async init() {
               this.attachEventListeners();
               await this.loadData();
               setInterval(() => this.refreshData(), CONFIG.autoRefreshInterval * 1000);
           },
           
           attachEventListeners() {
               document.getElementById('booking-btn').addEventListener('click', () => this.openForm());
               document.getElementById('cancel-btn').addEventListener('click', () => this.closeForm());
               document.getElementById('reservation-form').addEventListener('submit', (e) => this.handleSubmit(e));
               document.getElementById('increase-btn').addEventListener('click', () => this.updateQuantity(1));
               document.getElementById('decrease-btn').addEventListener('click', () => this.updateQuantity(-1));
           },
           
           async loadData() {
               try {
                   await this.loadBookings();
                   this.updateUI();
               } catch (error) {
                   console.error('שגיאה בטעינת הנתונים:', error);
               }
           },
           
           async refreshData() {
               await this.loadData();
           },
           
           async loadBookings() {
               try {
                   const timestamp = Date.now();
                   const url = `${CONFIG.urls.sheet}?t=${timestamp}`;
                   
                   const response = await fetch(url, {
                       cache: 'no-store',
                       headers: {
                           'Cache-Control': 'no-cache, no-store, must-revalidate',
                           'Pragma': 'no-cache'
                       }
                   });
                   
                   if (!response.ok) {
                       throw new Error(`HTTP error! status: ${response.status}`);
                   }
                   
                   const csvText = await response.text();
                   this.bookingsData = this.parseCSV(csvText);
                   
                   this.totalBooked = this.bookingsData
                       .filter(booking => 
                           (booking['entry.1414374653'] === CONFIG.project.name || 
                            booking['projectName'] === CONFIG.project.name)
                       )
                       .reduce((total, booking) => {
                           const quantity = 
                               parseInt(booking['הזמן']) || 
                               parseInt(booking['כמות']) || 
                               parseInt(booking['entry.1406108683']) ||
                               parseInt(booking['Quantity']) || 
                               parseInt(booking['quantity']) || 0;
                           
                           return total + quantity;
                       }, 0);
                   
               } catch (error) {
                   console.error('שגיאה בטעינת ההזמנות:', error);
                   this.totalBooked = 0;
               }
           },
           
           updateUI() {
               const totalBooked = this.totalBooked;
               const availableSlots = CONFIG.totalSlots - totalBooked;
               const progressPercentage = (totalBooked / CONFIG.totalSlots) * 100;
               
               document.getElementById('total-slots').textContent = CONFIG.totalSlots;
               document.getElementById('booked-slots').textContent = totalBooked;
               document.getElementById('available-slots').textContent = availableSlots;
               document.getElementById('booking-progress').style.width = `${progressPercentage}%`;
               
               const bookingBtn = document.getElementById('booking-btn');
               bookingBtn.disabled = availableSlots <= 0;
               bookingBtn.textContent = availableSlots > 0 ? 'הזמן עכשיו' : 'אזלו המקומות';
           },
           openForm() {
               document.getElementById('reservation-form').reset();
               document.getElementById('booking-form').style.display = 'block';
           },
           
           closeForm() {
               document.getElementById('booking-form').style.display = 'none';
           },
           
           updateQuantity(delta) {
               const quantityValueEl = document.getElementById('quantity-value');
               const quantityInputEl = document.getElementById('quantity');
               
               let currentValue = parseInt(quantityValueEl.textContent);
               let newValue = currentValue + delta;
               
               const availableSlots = parseInt(document.getElementById('available-slots').textContent);
               
               // בדיקות תקינות
               if (newValue < 1) newValue = 1;
               if (newValue > CONFIG.maxSlotsPerBooking) newValue = CONFIG.maxSlotsPerBooking;
               if (newValue > availableSlots) newValue = availableSlots;
               
               quantityValueEl.textContent = newValue.toString();
               quantityInputEl.value = newValue.toString();
           },
           
           async handleSubmit(event) {
               event.preventDefault();
               
               const formData = {
                   firstName: document.getElementById('firstName').value,
                   lastName: document.getElementById('lastName').value,
                   phone: document.getElementById('phone').value,
                   quantity: document.getElementById('quantity').value
               };
               
               // בדיקה שכל השדות מלאים
               if (!formData.firstName || !formData.lastName || !formData.phone || !formData.quantity) {
                   alert('יש למלא את כל השדות');
                   return;
               }
               
               // בדיקת תקינות טלפון
               if (!/^\d{10}$/.test(formData.phone)) {
                   alert('יש להזין מספר טלפון תקין (10 ספרות)');
                   return;
               }
               
               // בדיקת זמינות בזמן אמת
               await this.loadBookings();
               const availableSlots = CONFIG.totalSlots - this.totalBooked;
               
               if (parseInt(formData.quantity) > availableSlots) {
                   alert(`אין מספיק מקומות פנויים. נותרו ${availableSlots} מקומות.`);
                   return;
               }
               
               try {
                   const googleFormData = new FormData();
                   googleFormData.append(CONFIG.formFields.firstName, formData.firstName);
                   googleFormData.append(CONFIG.formFields.lastName, formData.lastName);
                   googleFormData.append(CONFIG.formFields.phone, formData.phone);
                   googleFormData.append(CONFIG.formFields.quantity, formData.quantity);
                   googleFormData.append(CONFIG.formFields.projectName, CONFIG.project.name);
                   
                   await fetch(CONFIG.urls.form, {
                       method: 'POST',
                       body: googleFormData,
                       mode: 'no-cors'
                   });
                   
                   alert('ההזמנה התקבלה בהצלחה!');
                   this.closeForm();
                   await this.loadData();
                   
               } catch (error) {
                   console.error('שגיאה בשליחת ההזמנה:', error);
                   alert('אירעה שגיאה בעת שליחת ההזמנה. נא לנסות שוב.');
               }
           },
           
           parseCSV(csv) {
               try {
                   const cleanCsv = csv.replace(/\\r/g, '').trim();
                   const lines = cleanCsv.split('\n');
                   
                   if (lines.length <= 1) {
                       return [];
                   }
                   
                   const headerLine = lines[0];
                   let headers;
                   
                   if (headerLine.includes(',')) {
                       headers = headerLine.split(',').map(h => h.trim());
                   } else if (headerLine.includes('\t')) {
                       headers = headerLine.split('\t').map(h => h.trim());
                   } else {
                       headers = headerLine.split(/\s+/).map(h => h.trim());
                   }
                   
                   return lines.slice(1)
                       .filter(line => line.trim() !== '')
                       .map((line) => {
                           let values;
                           
                           if (line.includes(',')) {
                               values = line.split(',');
                           } else if (line.includes('\t')) {
                               values = line.split('\t');
                           } else {
                               values = line.split(/\s+/);
                           }
                           
                           const entry = {};
                           
                           headers.forEach((header, i) => {
                               entry[header] = i < values.length && values[i] ? values[i].trim() : '';
                           });
                           
                           return entry;
                       });
               } catch (error) {
                   console.error("Error parsing CSV:", error);
                   return [];
               }
           }
       };
       
       // אתחול המערכת
       document.addEventListener('DOMContentLoaded', () => {
           bookingSystem.init();
       });
   </script>
</body>
</html>
